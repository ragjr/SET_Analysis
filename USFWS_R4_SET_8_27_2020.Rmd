---
title: |
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | USFWS, Southeast Region SET Data Analysis
  | &nbsp;
  | &nbsp;
  | &nbsp;

subtitle: |
  | Zachary Ladin, 264 Townsend Hall, University of Delaware, Newark, DE 19716
  | Email: zach@udel.edu
  | &nbsp;
  | &
  | &nbsp;
  | Michelle Moorman, US Fish and Wildlife Service, Inventory & Monitoring Branch,
  | South Atlantic - Gulf and Mississippi Basins, 551 Pylon Dr # F, Raleigh, NC 27606
  | &nbsp;
  
date: | 
  | `r format(Sys.time(), '%d %B %Y')`
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
  | &nbsp;
output: 
  pdf_document:
    latex_engine: pdflatex
    fig_caption: no
    toc: yes
    toc_depth: '4'
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage[normalem]{ulem}
bibliography: My_Library.bib
csl: ecology.csl
---



```{r, echo=FALSE}
library(knitr)
library(rmdformats)
library(formatR)

## Global options
options(max.print="85")
opts_chunk$set(echo=FALSE,
               message=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               fig.align="center"
               # out.width=6.5,
               # out.height=9
               )
opts_knit$set(width=80)
opts_knit$set(root.dir = '/Users/zach/Dropbox (ZachTeam)/Projects/SET_USFWS_Region_4/Reports/RMarkdown_pdf')

#library(shadowtext)
  
```

\newpage

## Overview

Wetland ecosystems are critical for providing important ecological functions. For example, tidal marshes and coastal wetlands help in absorbing energy of storms and preserving shorelines, improving water quality in bays and estuaries, providing nutrients to marine food webs, and supplying critical habitat for both the reproduction of a suite of ocean species and for use by an entire community of breeding and migratory birds. Wildlife species that depend on wetlands are some of the highest conservation priorities, many of which occur in coastal US Fish and Wildlife Service National Wildlife Refuges. Wetlands are increasingly influenced to some extent by anthropogenic alteration, and are threatened by accelerated rates of sea-level rise. 

The goal of this project under a cooperative agreement between US Fish & Wildlife Service and the University of Delaware, is to further improve existing code that Zach Ladin developed previously for modeling, analyzing, and generating trend-estimation graphs and reports of surface elevation table (SET) data for regions and refuge managers, and for extending this functionality for incorporation within the USFWS National SET Application. Using these tools, an updated report integrating existing SET data from USFWS Northeast and Southeast Regions will be generated.

The US Fish and Wildlife Service Legacy Region 4 has implemented the Coastal Wetland Elevation Monitoring Protocol [@moorman_et_al_2019; @moorman_and_rankin_2020] in an ongoing effort to assess and track the condition of wetland habitats on USFWS Refuges. The development of analytical tools using data from this long-term monitoring program will help identify priority analyses for refuge-specific monitoring and management decisions. Here, we extend a recently-completed suite of analysis functionality within program R [@r-base] that was developed to analyze the surface elevation table (SET) data collected by the US Fish and Wildlife Service and other partnering institutions in Legacy Region 4. This report contains results using these tools to analyze SET data from the southeast region (Legacy Region 4) USFWS refuges.

## Objectives

1)	Analyze SET data to determine temporal trends in the relative change in wetland surface elevation (mm) in US Fish & Wildlife Service, Southeast Region.
2)	Improve analytical tools and incorporate user feedback in program R [@r-base] to facilitate current and future automated analysis of SET data.
3) Integrate functions for formatting, QA/QC'ing, analyzing, and visualizing results of SET data for use in the USFWS SET online Application (https://ecos.fws.gov/SET)

## Methods

We developed data analysis tools in program R [@r-base] that enables users to analyze SET data using methods described in the SOP 8: SET and Marker Horizon Data Analysis [@lynch_surface_2015]. This analysis includes data collected from USFWS refuges located in Legacy Region 4 (Table 1). Data was acquired from reports that were downloaded from: https://ecos.fws.gov/SET/Report/setusers/Export%20Pin%20Data. Standardized column headers and fields for SET data entered into the National SET Application were discussed and refined, to enable the streamlining of data processing and integration with functions included within the R code used in the present analysis.

We first visualized SET data, by computing changes in wetland elevation (mm) at each pin, and plotted these relative wetland heights against time (years).  Then, by averaging among SET stations, discrete wetland monitoring sites, and National Wildlife Refuges (NWRs), produced figures showing (mean $\pm$ SE) relative changes in wetland elevation (mm/year). We converted raw SET measurements of wetland surface elevation (mm) to the rate of change in surface elevation (mm/year; hereafter delta SET) from the initial measurement at time (t0), following methods described in @lynch_surface_2015. To calculate mean and variance estimates of delta SET at higher-levels, we averaged delta SET estimates (i.e., slopes of regression models) over the four positions, and then these were averaged to get SET station-level estimates (Lynch et al. 2015). We then computed higher-level estimation of rates (i.e., mean $\pm$ SE slope of delta SET) at the wetland site level, NWR Unit level, and at the regional scale.  Additionally, we developed NWR and Site-level summaries for assessment of local-scale changes in wetland elevation change dynamics.


```{r setup, message=FALSE, warning=FALSE}

suppressMessages({

#load packages
library(httr)
library(markdown)
library(rmdformats)
library(stringr)
library(lme4)
library(lmerTest)
library(plyr)
library(reshape)
library(RColorBrewer)
library(colorRamps)
library(ggplot2)
library(ggrepel)
library(grid)
library(lubridate)
library(ggmap)
library(scales)
library(spatstat)
library(ggsn)
library(data.table)
library(ggpmisc)
library(xtable)
library(pander)
#library(shadowtext)

options(xtable.floating = FALSE)
options(xtable.timestamp = "")

#Load functions
message("Loading source files (these are all the functions).")
source("/Users/zach/Dropbox (ZachTeam)/Projects/SET_USFWS_Region_4/Reports/RMarkdown_pdf/R_source/summaryFunction.R")
source("/Users/zach/Dropbox (ZachTeam)/Projects/SET_USFWS_Region_4/Reports/RMarkdown_pdf/R_source/formatSETdataR4.R")
source("/Users/zach/Dropbox (ZachTeam)/Projects/SET_USFWS_Region_4/Reports/RMarkdown_pdf/R_source/computeTrends.R")

#register Google Maps API key
register_google(key="AIzaSyDerv2JQubJ_Dg8_RKBZCeyo5zqsM5USw0")

})
```


## Results

### Statement of Progress
1)	We are continuing to work cooperatively, and have identified the following analysis priorities for data associated with SET data. In this case we address priorities associated specifically with wetland surface elevation table (SET) data:

2)	We analyzed data collected at SET stations (*N* = 58) located within monitoring sites (*N* = 21; Fig. 1) among 18 NWRs  within the USFWS Southeast Legacy Region 4 (Table 1). 

3)	We have developed analytical tools in program R [@r-base] to facilitate current and future analysis of SET data. Extensive R code is provided in the form of scripts (.R files) that contain functions to format data, summarize data in tabular and graphical formats, analyze data, save results (tables and figures), and produce R Markdown files (.Rmd) that can generate .doc, .html, or .pdf reports. All R code is thoroughly annotated with clear comments to help users implement analyses using program R and R Studio.
    
4)	We compared spatial patterns in SET trends within and among sampling locations through the visualization of spatial trend estimates of delta SET rates (mm/year), by providing R code that creates maps of SET stations and displays the trend direction (positive, negative) along with the magnitude of the trend. These maps provide a nice visualization tool, that hopefully, refuge biologists can use to quickly assess patterns of wetland elevation trends at particular SET stations.


```{r, warning=FALSE, message=FALSE}

#build function to read in and combine data
combineData<-function(fileList){
  
  data.comb<-list()
  for(i in 1:length(fileList)){
    
    new.data<-read.csv(fileList[i],skip=3, header=TRUE)
    data.comb<-rbind(data.comb,new.data)
  }
return(data.comb) 
}

myFileList<-list.files("/Users/zach/Dropbox (ZachTeam)/Projects/SET_USFWS_Region_4/Reports/RMarkdown_pdf/Data/Refuge_Data_8-7-2020", full.names=TRUE)

data.comb<-combineData(fileList = myFileList)

#Export data
write.csv(data.comb, file="/Users/zach/Dropbox (ZachTeam)/Projects/SET_USFWS_Region_4/Reports/RMarkdown_pdf/Data/Refuge_Data_8-7-2020.csv",row.names=FALSE)

```



```{r }
#read in raw data from USFWS SET database
rawData<-read.csv(file="/Users/zach/Dropbox (ZachTeam)/Projects/SET_USFWS_Region_4/Reports/RMarkdown_pdf/Data/Refuge_Data_8-7-2020.csv" , header=TRUE,as.is=TRUE)

#remove second row of data where DataProcessingLevelCode=="R" for "replicates
#rawData.sub<-subset(rawData, DataProcessingLevelCode !="R")

#rawData.Replicates<-subset(rawData, DataProcessingLevelCode =="R")

```


```{r , message=FALSE}

#my working dir
mydir<-"/Users/zach/Dropbox (ZachTeam)/Projects/SET_USFWS_Region_4/Reports/RMarkdown_pdf"

#format data providing rawData object and mydir (a filepath to a folder named "Data" where SET_coords.csv file is saved)
data.formatted<-try(formatSETdataR4(dataIn=rawData, dataDir=mydir))

#remove 

#head(data.formatted)
```

\newpage

#### Table 1. List of 22 sites among 19 US Fish and Wildlife Service National Wildlife Refuge (NWR) units included in SET data analyses along with corresponding State, count of SET stations, count of unique observers, duration of years, and starting and ending years of data collection. 
```{r, message=FALSE, warning=FALSE}

data<-data.formatted

#make Year an integer
data$Year<-as.integer(as.character(data$Year))

data.table.1<-unique(data[,c("State","RefugeName","Site_Name")])

#remove NAs
data.table.1<-data.table.1[complete.cases(data.table.1),]

#get freqency of SET stations per refuge
sub.data<-unique(data[,c("State","RefugeName","Site_Name","Plot_Name")])
count.stations<-table(sub.data$Site_Name, sub.data$Plot_Name)
count.stations.total<-rowSums(count.stations)
count.stations.total.1<-data.frame(Site_Name=names(count.stations.total), N=as.data.frame(count.stations.total))

#get years sampled (start and end), and get number of observers
sub.data.years<-unique(data[,c("Site_Name","Year","ReaderFullName")])

#get refugeList
siteList<-unique(sort(as.character(sub.data.years$Site_Name)))

#loop over refugeList to get range of years per refuge
range.years<-list()
for(i in 1:length(siteList)){
  #subset data for 1 refuge
  new.data<-subset(sub.data.years,Site_Name==siteList[i])
  #get RefugeName
  siteName<-as.character(unique(new.data$Site_Name))
  #get starting year
  startYear<-min(new.data$Year)
  #get ending year
  endYear<-max(new.data$Year)
  #get total years
  nYears<-endYear-startYear
  #get n unique observers (data recorders)
  nObs<-length(unique(new.data$ReaderFullName))

  range.years.1<-data.frame(Site_Name=siteName, startYear=startYear, endYear=endYear, nYears=nYears,nObs=nObs)
  range.years<-rbind(range.years, range.years.1)

}

#combine with SummaryTable.1
data.table.2<-na.omit(merge(data.table.1, count.stations.total.1, by="Site_Name",all.x=TRUE))

#now combine with range.years
data.table.3<-merge(data.table.2, range.years, by="Site_Name")

#get Site order sorted North to South
siteLat<-aggregate(Latitude~Site_Name, data=data, FUN="mean")
siteOrder<-siteLat[order(siteLat$Latitude, decreasing = TRUE),]
siteOrderList<-unique(siteOrder$Site_Name)
#length(refugeOrderList)

#Now sort table by Latitude (reorder RefugeName factor)
#create data.frame with NWRs ordered from North to South
SiteOrder.df<-data.frame(Site=siteOrderList, orderNum=seq(1:length(siteOrderList)))

#rename column headers
colnames(data.table.3)<-c("Site", "State","Refuge","N",
                            "Start_Year","End_Year","Num_Years","Num_Obs")

#reorder columns
data.table.4<-data.table.3[,c("Site","State","Refuge","N","Num_Obs","Num_Years","Start_Year","End_Year")]

#create integer column of order for NWRs
data.table.order<-merge(data.table.4, SiteOrder.df, by=c("Site"),all.x=TRUE)
data.table.order<-data.table.order[order(data.table.order$orderNum),]
data.table.5<-data.table.order
data.table.5$orderNum<-NULL

#remove row.names from table
row.names(data.table.5)<-NULL

#rename column headers
colnames(data.table.5)<-c("Site", "State","NWR","SETs (N)", "Observers (N)","Num. Years","Start Year","End Year")

# kable(data.table.5, digits=2) %>%
#   kable_styling(bootstrap_options = "striped", full_width = TRUE, font_size = 12)
panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left'))
panderOptions("table.split.table", Inf)

pander(data.table.5)

```

\newpage

#### Figure 1. Study Area showing sites (*N* = 22) where SET benchmarks are located among 19 USFWS National Wildlife Refuges, Southeast Legacy Region 4. 
```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=10, dpi=150}
#Map with study area locations

#get locations of SETs
SETcoords<-unique(data[, c("RefugeName","Site_Name","Plot_Name","Longitude","Latitude")])

#aggregate to get Site coords
site.long<-aggregate(Longitude~Site_Name+RefugeName, data=SETcoords, FUN=mean)
site.lat<-aggregate(Latitude~Site_Name+RefugeName, data=SETcoords, FUN=mean)
site.coords.merge<-merge(site.long, site.lat, by=c("Site_Name","RefugeName"),all=TRUE)

meanLong<-mean(SETcoords$Longitude)
meanLat<-mean(SETcoords$Latitude)

#get basemap
basemap<-get_map(location=c(meanLong, meanLat),zoom=6, maptype="terrain-background")
#ggmap(basemap)

#get map extent
mapExtent<-attr(basemap, "bb")


studyAreaMap<-ggmap(basemap)+
  geom_point(data=site.coords.merge, aes(x=Longitude, y=Latitude),color="black",size=3)+
  labs(x="Longitude",y="Latitude")+
  theme(
    axis.text=element_text(size=18),
    axis.title=element_text(size=22),
    panel.border=element_rect(fill="transparent", color="black"),
    legend.position = "none"
    # legend.position = c(0.15,0.7),
    # legend.key.size = unit(2,"line"),
    # legend.text = element_text(size=14),
    # legend.title=element_text(size=20),
    # legend.background = element_rect(fill=alpha("white",0.9), color="black")
  )+
  # geom_label_repel(data=site.coords.merge,aes(x=Longitude,y=Latitude, label=Site_Name), fill="gray30",color="white", show.legend=FALSE, label.padding=0.4, size=4, segment.alpha=0.7, alpha=0.8)+
  geom_text_repel(data=site.coords.merge,aes(x=Longitude,y=Latitude, label=Site_Name), show.legend=FALSE, size=4.5, segment.alpha=0.7,
                  color = "black", bg.color = "white", bg.r = 0.16)+
  guides(fill = guide_legend(title = "National Wildlife Refuge", label = FALSE))+
  ggsn::scalebar(x.min=mapExtent$ll.lon, x.max=mapExtent$ur.lon, y.min=mapExtent$ll.lat, y.max=mapExtent$ur.lat,transform=TRUE, dist_unit="km",dist=200, st.dist=0.015, height = 0.01,anchor=c(x=-73,y=28))

studyAreaMap

```

\newpage


#### Figure 2. Plot change in elevation data relative to initial height (mm) over time for all pin-level SET data.
```{r, fig.width=7, fig.height=5, dpi=150}

set.data.all<-data

  SETallDatesPlot<-ggplot(data=set.data.all, aes(x=Date, y=value, group=1))+
    geom_point(aes(color=value),alpha=0.7, size=1, shape=16)+
    scale_color_gradient2(low="tomato",mid="gray60",high="royalblue1", guide_colorbar(title="Delta Elev. (mm)"))+
    #geom_path(aes(color=Plot_Name),alpha=0.2)+
    geom_smooth(method=lm, fullrange=TRUE, linetype=1, color="gray20", se=TRUE)+
    scale_y_continuous(expand=c(0.1,0.1))+
    scale_x_date(date_breaks = "1 year",date_labels = "%Y")+
        theme(panel.background = element_rect(color="black",fill="transparent"),
          panel.border = element_rect(color="black", fill="transparent"),
          axis.text.x = element_text(size=12, color="black"),
          axis.text.y = element_text(size=12, color="black"),
          axis.title.x = element_text(size=14, hjust=0.5, vjust=1.9),
          axis.title.y = element_text(angle = 90, vjust=1.2, size=14),
          legend.position = c(0.11,0.2),
          legend.key.size = unit(1,"line"))+
    geom_hline(yintercept=0, linetype=2, color="gray30",alpha=0.8)+
    stat_poly_eq(formula = y~ x, eq.with.lhs = "italic(hat(y))~`=`~",aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), parse = TRUE)+
    labs(x="Year",y="Relative change in pin height (mm)")

  SETallDatesPlot
```

\newpage

#### Table 2. List of Locations with outliers (e.g., relative change in height (mm) > 400 mm or < -400 mm)
```{r}

set.data.findOutliers<-subset(set.data.all, c(value > 400 | value < -400))

#simplify
set.outliers<-set.data.findOutliers[,c("State","RefugeName","Site_Name","Plot_Name","EventDate","Date","PipeDirectionAzimuth","variable","value")]

#get unique filtering term
set.outliers$Plot_Date_Arm_Pin<-paste(set.outliers$Plot_Name, set.outliers$EventDate,set.outliers$PipeDirectionAzimuth,set.outliers$variable, sep="_")

#bring in raw data to check for flags or comments?
rawData$Plot_Date_Arm_Pin<-paste(rawData$Plot_Name, rawData$EventDate, rawData$PipeDirectionAzimuth, paste("Pin",rawData$PinPosition,sep=""), sep="_")

#get list of outliers
outlierList<-unique(set.outliers$Plot_Date_Arm_Pin)

#subset rawData
rawData.outliers<-subset(rawData, Plot_Date_Arm_Pin %in% outlierList)

outliers.sub<-rawData.outliers[,c("Site_Name","Plot_Name","EventDate","PipeDirectionAzimuth","PinPosition","PinLength_mm","PinHeight_mm")]

row.names(outliers.sub)<-NULL

colnames(outliers.sub)<-c("Site","Plot","Date","Pipe Direction","Pin Position","Pin length (mm)","Pin height (mm)")

# kable(outliers.sub, digits=2) %>%
#   kable_styling(bootstrap_options = "striped", full_width = TRUE, font_size = 7)

panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left'))
panderOptions("table.split.table", Inf)

pander(outliers.sub)

```

\newpage

#### Figure 3. Plot change in elevation data relative to initial height (mm) over time for SET data without outliers.
```{r, message=FALSE,fig.width=7, fig.height=5, dpi=150}

set.data.noOutliers<-subset(set.data.all, c(value < 400 & value > -400))

  SETallDatesPlot_noOutliers<-ggplot(data=set.data.noOutliers, aes(x=Date, y=value, group=1))+
    geom_point(aes(color=value),alpha=0.7, size=1, shape=16)+
    scale_color_gradient2(low="tomato",mid="gray60",high="royalblue1", guide_colorbar(title="Delta Elev. (mm)"))+
    #geom_path(aes(color=Plot_Name),alpha=0.2)+
    geom_smooth(method=lm, fullrange=TRUE, linetype=1, color="gray20", se=TRUE)+
    scale_y_continuous(expand=c(0.1,0.1))+
    scale_x_date(date_breaks = "1 year",date_labels = "%Y")+
        theme(panel.background = element_rect(color="black",fill="transparent"),
          panel.border = element_rect(color="black", fill="transparent"),
          axis.text.x = element_text(size=12, color="black"),
          axis.text.y = element_text(size=12, color="black"),
          axis.title.x = element_text(size=14, hjust=0.5, vjust=1.9),
          axis.title.y = element_text(angle = 90, vjust=1.2, size=14),
          legend.position = c(0.11,0.2),
          legend.key.size = unit(1,"line"))+
    geom_hline(yintercept=0, linetype=2, color="gray30",alpha=0.8)+
    stat_poly_eq(formula = y~ x,eq.with.lhs = "italic(hat(y))~`=`~",aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), parse = TRUE)+
    labs(x="Year", y="Relative change in pin height (mm)")

  SETallDatesPlot_noOutliers

```

\newpage

```{r, echo=FALSE, message=FALSE, results = "hide"}
#test computeTrends
computeTrends(dataIn=set.data.noOutliers)

```

\newpage

#### Figure 4. Plot change in elevation data relative to initial height (mm) over time for all SET data.
```{r, message=FALSE, fig.width=16, fig.height=20}

# find significant trends: For this section we need to use the regress, 
# then average method, with no observer effects use values from 
# computeTrends() above 'all

stationList<-unique(set.data.noOutliers$Plot_Name)

station.sig.trends.out<-list()
for(i in 1:length(stationList)){
  
  #subset data
  new.station.data<-subset(set.data.noOutliers, Plot_Name==stationList[i])
  
  #fit simple linear regression model
  station.mod<-lm(value~Date, data=new.station.data)
  
  #get model summary stats
  mod.summary<-summary(station.mod)
  
  #create data.frame
  mod.summary.stats<-data.frame(Plot_Name=stationList[i],t(mod.summary$coefficients[2,]))
  
  #add column indicating significance
  mod.summary.stats$Significant<-ifelse(mod.summary.stats$Pr...t.. <= 0.05,"Yes","No")
  
  #add column indicating direction of trend
  mod.summary.stats$Trend<-ifelse(mod.summary.stats$Estimate>0 ,"Positive","Negative")
  #compile station model results
  station.sig.trends.out<-rbind(station.sig.trends.out, mod.summary.stats)
}

#now merge these results back with set.data.noOutliers
set.data.merge<-merge(set.data.noOutliers, station.sig.trends.out, by="Plot_Name",all.x=TRUE)

#add sig.trend column
set.data.merge$Sig_Trend<-ifelse(set.data.merge$Significant=="Yes" & set.data.merge$Trend=="Positive","Positive",
                                 ifelse(set.data.merge$Significant=="Yes" & set.data.merge$Trend=="Negative","Negative",
                                        "Not Significant"))

#set factor level order for Sig_Trend
set.data.merge$Sig_Trend<-factor(set.data.merge$Sig_Trend, levels=c("Positive","Not Significant","Negative"))

mySigColors<-c("royalblue1","gray20","tomato")
mySigFills<-c(alpha("royalblue1",0.3), alpha("gray20",0.3),alpha("tomato",0.3))

  SETallDatesPlot_noOutliers<-ggplot(data=set.data.merge, aes(x=Date, y=value, group=1))+
    geom_point(color="gray50",alpha=0.7, size=0.8, shape=16)+
    #geom_path(aes(color=Plot_Name),alpha=0.2)+
    geom_smooth(aes(color=Sig_Trend, fill=Sig_Trend),method=lm, fullrange=TRUE, linetype=1, se=TRUE)+
    scale_color_manual(values=mySigColors)+
    scale_fill_manual(values=mySigFills)+
    scale_y_continuous(expand=c(0.1,0.1))+
    scale_x_date(date_breaks = "2 year",date_labels = "%Y")+
        theme(panel.background = element_rect(color="black",fill="transparent"),
          panel.border = element_rect(color="black", fill="transparent"),
          axis.text.x = element_text(size=10, color="black"),
          axis.text.y = element_text(size=10, color="black"),
          axis.title.x = element_text(size=12, hjust=0.5, vjust=1.9),
          axis.title.y = element_text(angle = 90, vjust=1.2, size=12),
          legend.position = "top",
          legend.key.size = unit(1,"line"),
          legend.text = element_text(size=10),
          legend.title=element_text(size=12),
          legend.background = element_rect(fill=alpha("white",0.9), color="black"))+
    geom_hline(yintercept=0, linetype=2, color="gray30",alpha=0.8)+
    stat_poly_eq(formula = y~ x,eq.with.lhs = "italic(hat(y))~`=`~",aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), parse = TRUE, size=4)+
    labs(x="Year", y="Relative difference in pin height (mm)")


  
#try facet by SET
  SETallDatesPlot_noOutliers_Facet<-SETallDatesPlot_noOutliers+facet_wrap(~Plot_Name, scales="free", drop=TRUE, ncol=5)+
    theme(strip.text=element_text(size=13))

  SETallDatesPlot_noOutliers_Facet

```


\newpage

#### Table 3. Site-level trend estimates mean, and upper and lower 95% confidence intervals for change in wetland elevation (mm/year).
```{r}
#get sorted RefugeName levels
refuge.order<-all.refuges[order(all.refuges$mean,decreasing=TRUE),]
refuge.order$RefugeName<-factor(refuge.order$RefugeName, levels=unique(as.character(refuge.order$RefugeName)))

site.order<-all.sites
#order by Latitude from SiteOrder.df
site.order$Site_Name<-factor(site.order$Site_Name, levels=unique(SiteOrder.df$Site),ordered = TRUE)
#levels(site.order$Site_Name)

site.order<-site.order[order(site.order$Site_Name,decreasing=FALSE),]

site.order.table<-site.order[,c("Site_Name","RefugeName","State","n","mean","SE","lwr","upr")]
colnames(site.order.table)<-c("Site","NWR","State","N","Mean","SE", "Lower 95% CI", "Upper 95% CI")

row.names(site.order.table)<-NULL

panderOptions('table.alignment.default', function(df) ifelse(sapply(df, is.numeric), 'right', 'left'))
panderOptions("table.split.table", Inf)

pander(site.order.table)

```

\newpage

#### Figure 5. Site-level trend (mean $\pm$ SE) in change in wetland elevation (mm/year).
```{r, fig.width=7, fig.height=6, dpi=150}

#get sorted RefugeName levels
refuge.order<-all.refuges[order(all.refuges$mean,decreasing=TRUE),]
refuge.order$RefugeName<-factor(refuge.order$RefugeName, levels=unique(as.character(refuge.order$RefugeName)))

#sort by mean
site.order<-all.sites[order(all.sites$mean,decreasing=TRUE),]

#site.order$Site_Name<-all.sites[order(all.sites$RefugeName, all.sites$mean,decreasing=FALSE),]
site.order$RefugeName<- factor(site.order$RefugeName, levels=refuge.order$RefugeName[order(refuge.order$mean,decreasing = TRUE)], ordered=TRUE)

#order by Site_Name
site.order$Site_Name<-factor(site.order$Site_Name, levels=site.order$Site_Name[order(site.order$RefugeName,decreasing = FALSE)], ordered=TRUE)

site.trend.plot<-ggplot(data=site.order, aes(x=Site_Name, y=mean))+
  #coord_flip()+
  geom_bar(stat="identity",aes(fill=mean),alpha=0.9)+
  geom_errorbar(aes(ymin=mean-SE, ymax=mean+SE, color=mean),width=0, show.legend=FALSE)+
  geom_hline(yintercept = 0, linetype=2, color=alpha("lightgray",0.8))+
  scale_color_gradient2(low="tomato",mid="gray60",high="royalblue1")+
  scale_fill_gradient2(low="tomato",mid="gray60",high="royalblue1")+
  theme(panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill="transparent",color="black"),
        axis.text.x=element_text(angle=90,  vjust=0.5, hjust=1),
        legend.position = c(0.08,0.22),
        legend.background = element_rect(fill = "white", colour = "transparent"))+
  #labs(y="Trend (mm/year)", x="Refuge",title="Site-level mean (±SE) trend (mm/year) in change in wetland elevation.", fill="Trend", color=NULL)
  labs(y="Trend (mm/year)", x="Refuge", fill="Trend", color=NULL)

print(site.trend.plot)

```

\newpage

#### Figure 6. SET Station-level trend (mean $\pm$ SE) in change in wetland elevation (mm/year).
```{r, fig.width=7, fig.height=6, dpi=150}
#sort by mean
station.order<-all.stations[order(c(all.stations$mean),decreasing=TRUE),]
#order Station levels
station.order$Plot_Name<-factor(station.order$Plot_Name, levels=rev(unique(as.character(station.order$Plot_Name))))
#order Station levels
station.order$Site_Name<-factor(station.order$Site_Name, levels=rev(unique(as.character(station.order$Site_Name))))

#order by Refuge
station.order$RefugeName<-factor(station.order$RefugeName, levels=unique(as.character(refuge.order$RefugeName)))

#sort by mean
station.order<-all.stations[order(c(all.stations$mean),decreasing=TRUE),]

#get sorted RefugeName levels
refuge.order<-all.refuges[order(all.refuges$mean,decreasing=TRUE),]
refuge.order$RefugeName<-factor(refuge.order$RefugeName, levels=unique(as.character(refuge.order$RefugeName)))

#sort by mean
station.order<-all.stations[order(all.stations$mean,decreasing=TRUE),]

#site.order$Site_Name<-all.sites[order(all.sites$RefugeName, all.sites$mean,decreasing=FALSE),]
station.order$RefugeName<- factor(station.order$RefugeName, levels=refuge.order$RefugeName[order(refuge.order$mean,decreasing = TRUE)], ordered=TRUE)

#order by Site_Name
station.order$Plot_Name<-factor(station.order$Plot_Name, levels=station.order$Plot_Name[order(station.order$RefugeName,decreasing = FALSE)], ordered=TRUE)

station.trend.plot<-ggplot(data=station.order, aes(x=Plot_Name, y=mean))+
  geom_bar(stat="identity",aes(fill=mean),alpha=0.9)+
  geom_errorbar(aes(ymin=mean-SE, ymax=mean+SE, color=mean),width=0, show.legend=FALSE)+
  geom_hline(yintercept = 0, linetype=2, color=alpha("lightgray",0.8))+
  scale_color_gradient2(low="tomato",mid="gray60",high="royalblue1")+
  scale_fill_gradient2(low="tomato",mid="gray60",high="royalblue1")+
  theme(panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill="transparent",color="black"),
        axis.text.x=element_text(angle=90,  vjust=0.5, hjust=1, size=5),
        legend.position = c(0.08,0.22),
        legend.background = element_rect(fill = "white", colour = "transparent"))+
  #labs(y="Trend (mm/year)", x="SET Station Name",title="Station-level mean (±SE) trend (mm/year) in change in wetland elevation.", fill="Trend", color=NULL)
  labs(y="Trend (mm/year)", x="SET Station Name", fill="Trend", color=NULL)

print(station.trend.plot)

```


\newpage

#### Figure 7. Regional map showing site-level trends.
```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=10, dpi=150}
#Map with study area locations

#get locations of SETs
SETcoords<-unique(data[, c("RefugeName","Site_Name","Plot_Name","Longitude","Latitude")])

#aggregate to get Site coords
site.long<-aggregate(Longitude~Site_Name+RefugeName, data=SETcoords, FUN=mean)
site.lat<-aggregate(Latitude~Site_Name+RefugeName, data=SETcoords, FUN=mean)
site.coords.merge<-merge(site.long, site.lat, by=c("Site_Name","RefugeName"),all=TRUE)

#merge with site-level means
site.order.merge<-merge(site.order, site.coords.merge, by=c("Site_Name","RefugeName"),all.x=TRUE)

#add magnitude column with multiple
site.order.merge$Magnitude<-abs(site.order.merge$mean)

meanLong<-mean(SETcoords$Longitude)
meanLat<-mean(SETcoords$Latitude)

#get basemap
meanLong<-mean(SETcoords$Longitude)
meanLat<-mean(SETcoords$Latitude)

#get basemap
basemap<-get_map(location=c(meanLong, meanLat),zoom=6, maptype="satellite")
#ggmap(basemap)

#get map extent
mapExtent<-attr(basemap, "bb")


trendMapRegion<-ggmap(basemap,darken = c(0.3, "gray20"))+
  geom_point(data=site.order.merge, aes(x=Longitude, y=Latitude, color=mean), size=4,alpha=0.8, position=position_jitter(width=0.1, height=0.1))+
  scale_color_gradient2(low="tomato",mid="gray60",high="royalblue1", guide_colorbar(title="Trend (mm/year)"))+
  #scale_size_binned(range=c(4,30))+
  labs(x="Longitude",y="Latitude")+
  theme(
    axis.text=element_text(size=14),
    axis.title=element_text(size=16),
    panel.border=element_rect(fill="transparent", color="black"),
    #legend.position = "none"
    legend.position = c(0.8,0.23),
    legend.key.size = unit(2,"line"),
    legend.text = element_text(size=12, color="white"),
    legend.title=element_text(size=14, color="white"),
    legend.background = element_rect(fill="transparent")
  )+
  # geom_label_repel(data=site.coords.merge,aes(x=Longitude,y=Latitude, label=Site_Name), fill="gray30",color="white", show.legend=FALSE, label.padding=0.4, size=6, segment.alpha=0.7, alpha=0.8)+
    geom_text_repel(data=site.order.merge,aes(x=Longitude,y=Latitude, label=Site_Name, color=mean), show.legend=FALSE, size=4.5, segment.alpha=0.7,
                  bg.color = "white", bg.r = 0.16)+
  ggsn::scalebar(x.min=mapExtent$ll.lon, x.max=mapExtent$ur.lon, y.min=mapExtent$ll.lat, y.max=mapExtent$ur.lat,transform=TRUE, dist_unit="km",dist=200, st.dist=0.015, height = 0.01,anchor=c(x=-73,y=28),st.color = "white")

trendMapRegion

```

\newpage


### Station-level summaries showing map of SET stations with trends, and station-level trend plots.

\  
\  
\  
\  

```{r, message=FALSE, warning=FALSE, results='asis'}

#subchunkify function to produce figures of differing dimmensions within the same r chunk
subchunkify <- function(g, fig_height=6, fig_width=4) {
  g_deparsed <- paste0(deparse(
    function() {g}
  ), collapse = '')
  
  sub_chunk <- paste0("
  `","``{r sub_chunk_", floor(runif(1) * 10000), ", fig.height=", fig_height, ", fig.width=", fig_width, ", echo=FALSE}",
  "\n(", 
    g_deparsed
    , ")()",
  "\n`","``
  ")
  
  cat(knitr::knit(text = knitr::knit_expand(text = sub_chunk), quiet = TRUE))
}

#function to wrap long titles 
wrapper <- function(x, ...) 
{
  paste(strwrap(x, ...), collapse = "\n")
}

#get site-level means
siteList<-unique(station.order$Site_Name)

for(i in 1:length(siteList)){
  
  #get locations of SETs
  new.SETcoords<-subset(station.order, Site_Name==siteList[i])
  
  #get site sampling info
  site.sampling.info<-subset(data.table.5, Site==siteList[i])
  
  #get site name
  siteName<-as.character(unique(new.SETcoords$Site_Name))
  
  #get refugeName
  refugeName<-as.character(unique(new.SETcoords$RefugeName))
  
  #get overall, site-level mean
  site.mean.df<-subset(site.order, Site_Name==siteList[i])
  
  #aggregate to get Site coords
  site.long<-aggregate(Longitude~Site_Name+RefugeName, data=new.SETcoords, FUN=mean)
  site.lat<-aggregate(Latitude~Site_Name+RefugeName, data=new.SETcoords, FUN=mean)
  
  meanLong<-mean(new.SETcoords$Longitude)
  meanLat<-mean(new.SETcoords$Latitude)

  left.coord=meanLong- (meanLong-min(new.SETcoords$Longitude))
  bottom.coord=meanLat-(meanLat-min(new.SETcoords$Latitude))
  right.coord=meanLong+(max(new.SETcoords$Longitude)-meanLong)
  top.coord=meanLat+(max(new.SETcoords$Latitude)-meanLat)
  
  #set zoom 
  plotZoom=ifelse(siteName=="Harris Neck", 11, 
                  ifelse(siteName=="Cape Romain - Horsehead Key",14,17))

  #scale location multiple
  plotScaleAnchorX=ifelse(siteName=="Cape Romain - Horsehead Key",0.99983, 
                          ifelse(siteName=="Harris Neck",0.998,0.99993))
  plotScaleAnchorY=ifelse(siteName=="Cape Romain - Horsehead Key",0.99975, 
                          ifelse(siteName=="Harris Neck",0.99641,0.999935))
  
  #scalebarDist
  scalebarDist=ifelse(siteName=="Harris Neck",5, 0.3)
  
  #get basemap
  #basemap<-get_map(location=c(left=left.coord, bottom=bottom.coord, right=right.coord,top=top.coord),zoom=plotZoom, maptype="terrain-background")
  basemap<-get_map(location=c(lon=meanLong, lat=meanLat),zoom=plotZoom, maptype="satellite")
#ggmap(basemap)
  
  #get map extent
  mapExtent<-attr(basemap, "bb")

trendMapSite<-ggmap(basemap,darken = c(0.2, "gray10"))+
  geom_point(data=new.SETcoords, aes(x=Longitude, y=Latitude, color=mean), size=4,alpha=0.9)+
  scale_color_gradient2(low="tomato",mid="gray60",high="royalblue1",limits=c(min(station.order$mean,na.rm=TRUE),max(station.order$mean, na.rm=TRUE)), guide_colorbar(title="Trend\n(mm/year)"))+
  #scale_size_binned(range=c(4,30))+
  labs(x="Longitude",y="Latitude")+
  theme(
    axis.text=element_text(size=10),
    axis.title=element_text(size=12),
    title=element_text(size=11),
    panel.border=element_rect(fill="transparent", color="black"),
    #legend.position = "none"
    legend.position = c(0.15,0.82),
    legend.key.size = unit(0.7,"line"),
    legend.text = element_text(size=8, color="white"),
    legend.title=element_text(size=10, color="white"),
    legend.background = element_rect(fill="transparent")
  )+
  geom_label_repel(data=new.SETcoords,aes(x=Longitude,y=Latitude, label=Plot_Name), fill="white",color="black", show.legend=FALSE,point.padding=0.8, label.padding=0.4, size=4, segment.alpha=0.7, alpha=0.8)+
  ggsn::scalebar(x.min=mapExtent$ll.lon, x.max=mapExtent$ur.lon, y.min=mapExtent$ll.lat, y.max=mapExtent$ur.lat,transform=TRUE, dist_unit="km",dist=scalebarDist, st.dist=0.02, st.size=3,height = 0.01,st.color = "white", anchor=c(x=right.coord*plotScaleAnchorX,y=bottom.coord*plotScaleAnchorY))+
  ggtitle(wrapper("A) Locations of SET stations showing elevation trends (mm/year).",width=50))

#add blank lines
#cat("\\newline")

#make pos.pin a factor
set.data.merge$pos.pin<-as.factor(set.data.merge$pos.pin)

#make column with colors
set.data.merge$trendColor<-ifelse(set.data.merge$Sig_Trend=="Positive","royalblue2",
                                  ifelse(set.data.merge$Sig_Trend=="Negative","tomato","gray20"))

#set factor levels for trendColor
#set.data.merge$trendColor<-factor(set.data.merge$trendColor, levels=c("Positive"))

plot.data<-subset(set.data.merge, Site_Name==siteName)

#get site level trend by regressing station-level means

  #fit simple linear regression model
  site.mod<-lm(value~Date, data=plot.data)
  
  #get model summary stats
  site.mod.summary<-summary(site.mod)
  
  #create data.frame
  site.mod.summary.stats<-data.frame(Plot_Name=siteList[i],t(site.mod.summary$coefficients[2,]))
  
  #add column indicating significance
  site.mod.summary.stats$Significant<-ifelse(site.mod.summary.stats$Pr...t.. <= 0.05,"Yes","No")
  
  #add column indicating direction of trend
  site.mod.summary.stats$Trend<-ifelse(site.mod.summary.stats$Estimate>0 ,"Positive","Negative")
  

#site-level sig. trend
plot.data$Site_Sig_Trend<-site.mod.summary.stats$Trend

#site-level significant trends factors
plot.data$Site_Sig_Trend<-factor(plot.data$Site_Sig_Trend, levels=c("Positive","Not Significant","Negative"))

  
#station-level significant trends factors
plot.data$Sig_Trend<-factor(plot.data$Sig_Trend, levels=c("Positive","Not Significant","Negative"))
levels(plot.data$Sig_Trend)

#choose line and fill colors
mycolors<-c("royalblue",I("gray30"),"red")
myfills<-c(alpha("royalblue",0.6),alpha(I("gray30"),0.6),alpha("red",0.6))


#now plot trends by EventDate
  SETallDatesSite_noOutliers<-ggplot(data=plot.data, aes(x=Date, y=value, group=1))+
    geom_point(color="gray50",alpha=0.7, size=1, shape=16)+
    #geom_path(aes(color=Plot_Name),alpha=0.2)+
        geom_smooth(aes(x=Date, y=value, group=pos.pin),method="lm",color="gray80",size=0.4,alpha=0.1,inherit.aes = FALSE, se=FALSE)+
geom_smooth(aes(color=Site_Sig_Trend, fill=Site_Sig_Trend),method=lm, fullrange=TRUE, linetype=1, se=TRUE,alpha=0.3)+
    scale_color_manual(values=mycolors, drop=FALSE)+
    scale_fill_manual(values=myfills,drop=FALSE)+
    scale_y_continuous(expand=c(0.1,0.1))+
    scale_x_date(date_breaks = "2 year",date_labels = "%Y")+
        theme(panel.background = element_rect(color="black",fill="transparent"),
          panel.border = element_rect(color="black", fill="transparent"),
          axis.text.x = element_text(size=7, color="black"),
          axis.text.y = element_text(size=7, color="black"),
          axis.title.x = element_text(size=9, hjust=0.5, vjust=1.9),
          axis.title.y = element_text(angle = 90, vjust=1.2, size=10),
          title=element_text(size=13),
          legend.position = "none",
          legend.key.size = unit(1,"line"),
          legend.text = element_text(size=8),
          legend.title=element_text(size=14),
          legend.background = element_rect(fill=alpha("white",0.9), color="transparent"))+
    geom_hline(yintercept=0, linetype=2, color="gray30",alpha=0.8)+
    stat_poly_eq(formula = y~ x,eq.with.lhs = "italic(hat(y))~`=`~",aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), parse = TRUE)+
    labs(x="Year", y="Relative difference in pin height (mm)", title = wrapper(paste("C) Pin-level slopes (light gray lines) and linear model trend (mean ± SE; shown in color, if significant) of relative change in wetland elevation mm/year at ", siteName, " site within ",refugeName, " NWR.",sep=""), width=80))
  

  #now set up plot for stations
    SETallDatesPlot_noOutliers<-ggplot(data=plot.data, aes(x=Date, y=value, group=1))+
    geom_point(color="gray50",alpha=0.7, size=1, shape=16)+
    #geom_path(aes(color=Plot_Name),alpha=0.2)+
        geom_smooth(aes(x=Date, y=value, group=pos.pin),method="lm",color="gray80",size=0.4,alpha=0.1,inherit.aes = FALSE, se=FALSE)+
geom_smooth(aes(color=Sig_Trend, fill=Sig_Trend),method=lm, fullrange=TRUE, linetype=1, se=TRUE,alpha=0.3)+
    scale_color_manual(values=mycolors,drop=FALSE)+
    scale_fill_manual(values=myfills,drop=FALSE)+
    scale_y_continuous(expand=c(0.1,0.1))+
    scale_x_date(date_breaks = "2 year",date_labels = "%Y")+
        theme(panel.background = element_rect(color="black",fill="transparent"),
          panel.border = element_rect(color="black", fill="transparent"),
          axis.text.x = element_text(size=7, color="black"),
          axis.text.y = element_text(size=7, color="black"),
          axis.title.x = element_text(size=9, hjust=0.5, vjust=1.9),
          axis.title.y = element_text(angle = 90, vjust=1.2, size=10),
          title=element_text(size=13),
          legend.position = "none",
          legend.key.size = unit(1,"line"),
          legend.text = element_text(size=8),
          legend.title=element_text(size=14),
          legend.background = element_rect(fill=alpha("white",0.9), color="transparent"))+
    geom_hline(yintercept=0, linetype=2, color="gray30",alpha=0.8)+
    stat_poly_eq(formula = y~ x,eq.with.lhs = "italic(hat(y))~`=`~",aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), parse = TRUE)+
    labs(x="Year", y="Relative difference in pin height (mm)", title = wrapper(paste("C) Pin-level slopes (light gray lines) and linear model trend (mean ± SE; shown in color, if significant) of relative change in wetland elevation (mm/year) at ", siteName, " site within ",refugeName, " NWR.",sep=""), width=80))


#create facet plot of individual stations
SETallDatesPlot_noOutliers_facet<-SETallDatesPlot_noOutliers+facet_wrap(~Plot_Name, drop=TRUE,ncol=1)+
  ggtitle(wrapper("B) Pin-level linear regression of change in elevation by sampling date (mm/year) among SET stations.", width=46))+
    theme(strip.text=element_text(size=8),
          legend.position = "bottom", 
          axis.title.y=element_text(size=12),
          title=element_text(size=10))

cat("\\vskip 1mm")

#Print Site name big
cat("\\begin{huge}")
  cat(siteName)
cat("\\end{huge}")

cat("\\vskip 1mm")

#Intro paragraph
cat("Surface elevation table (SET) data were collected between ",site.sampling.info$`Start Year`,"-",site.sampling.info$`End Year`," at A) ", site.sampling.info$`SETs (N)`, " SET stations at ",siteName, " within the ", refugeName, " NWR. The estimated trend in change in surface elevation (mean \u00B1 SE) was ", round(site.mean.df$mean,2), " \u00B1 ",round(site.mean.df$SE,2)," mm/year. Slope equations for pin-level linear regression models represent mean trends (mm/day) and are shown below for B) individual stations and C) at the site level.",sep="")

cat("\\vskip 1mm")

library(ggpubr)
#combine trendMapSite and 
plot1<-ggarrange(trendMapSite, SETallDatesPlot_noOutliers_facet, heights=c(1,0.7), widths=c(1,0.75))
#plot1<-ggarrange(trendMapSite, SETallDatesPlot_noOutliers_Site_facet,align = "v", heights=c(1.2,1), widths=1.3,1)

#print map
subchunkify(plot1, 6, 9)
#print(trendMapSite)
  
#plot Site
#print(SETallDatesPlot_noOutliers_Site)
subchunkify(SETallDatesSite_noOutliers, 3.7,9)

#add blank lines
#cat("\\newline")


#add blank lines
cat("\n\\clearpage\n")

}

```

\newpage
## Acknowledgments
We thank the following individuals for their help in several areas, and for providing valuable feedback and input into this project and report: Brent Frakes, Erin King, Laura Mitchell, Greg Shriver, and Adam Smith. We are grateful to all the Refuge staff who have collected the surface elevation data over the past 9 years, and Nicole Rankin and Mike Chouinard.
\  
\  
\  
\  

## References
<div id="refs"></div>

\newpage






## Appendix

### Appendix A. Pin-level regression plots at each SET station (among 4 arm positions)
```{r, eval=TRUE, fig.height=8, fig.width=7, dpi=150, results='asis'}

siteList<-site.order.table$Site

for(i in 1:length(siteList)){
  site.data<-subset(data, Site_Name==siteList[i])

    #get stationList
    stationList<-unique(as.character(site.data$Plot_Name))
    
      site.data$PositionLabels<-paste("Position ", site.data$PipeDirectionCode,sep="")
    
      pin.reg.plot<-ggplot(site.data, aes(x=Date, y=value))+
        geom_point(aes(color=variable),size=0.7,alpha=0.3)+
        geom_smooth(method="lm",aes(color=variable),se=FALSE,alpha=0.3, size=0.4)+
        scale_x_date(date_breaks="1 year",date_labels = "%b\n%Y", minor_breaks = "1 year")+
        ylab("Delta Elevation (mm)")+
        geom_hline(yintercept=0,linetype=2, color="darkgray")+
        theme(panel.background =element_rect(fill="white"),
              panel.grid.major=element_line(color=alpha("lightgray",0.4)),
              panel.border=element_rect(fill="transparent",color="black"),
              axis.text.x=element_text(size=10))
      #pin.reg.plot

      #plot of all pin-level linear models
      # pin.reg.plot+facet_wrap(Plot_Name~PositionLabels,ncol=4)+
      #   labs(color = "Pin")+
      #   ggtitle(paste(siteList[i],"-","SET",stationList[k], sep=" "))

      pin.reg.facet<-pin.reg.plot+facet_wrap(Plot_Name~PositionLabels,ncol=1)+
        labs(color = "Pin")+
        ggtitle(siteList[i])

      print(pin.reg.facet)
      
      #add blank lines
      cat("\n\\clearpage\n")

    
    }

```


\newpage

### Appendix B. Sourced functions used throughout the analysis.
\  

#### Function to format raw SET data.
\  
```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}

formatSETdataR4<-function(dataIn, dataDir){

  myDir<-as.character(dataDir)
  
  
  message("Reading raw data in.")
  new.data<-dataIn
  
  #remove PinHeight_mm = NA
  #new.data<-subset(new.data, !is.na(PinHeight_mm)
  
  #look at data
  head(new.data)
  
  #look at column header names
  names(new.data)
  ################################
  #are there double observers?  Yes, however, it appears the 
  #same observer made two measurements during a single sampling event, 
  #so these can't help us estimate observer-based measurement bias).
  
  #new.data$plot.date<-paste(new.data$Plot_Name, new.data$EventDate, sep="_")
  #doubObs<-as.data.frame(table(new.data$plot.date, new.data$ReaderFullName))
  #doubObsSub<-subset(doubObs, Freq !=0)
  
  #new.data$plot.date<-as.character(new.data$plot.date)
  
  #subset
  #new.data.sub<-subset(new.data, ReaderFullName=="Nicole Rankin")
  ################################
  
  #remove all OberservationTypeCode != R
  new.data.sub<-subset(new.data, ObservationTypeCode != "R")
  
  #Remove rows if they contain NAs or blank cells.
  data.1<-subset(new.data.sub, EventDate != "")
  #data.1<-na.omit(data.1)

  #Remove double observers (all where Contact_Order==2) add 
  #Contact_Order as column or if there is no Contact_Orer==2, set it all to 1
  
  #data.1<-subset(data.1, Contact_Order==1)
  data.1$Contact_Order <- 1
  
  #separate columns for arm position and pin
  # position_pin_sep<-read.table(text=as.character(data.1$PinPosition),sep="-")
  # colnames(position_pin_sep)<-c("Position","Pin")
  # position_pin_sep$Pin<-paste("Pin",position_pin_sep$Pin, sep="")
  # 
  # #add columns
  # data.1<-cbind(data.1, position_pin_sep)
  
  #create plot.event.position column
  position.df<-as.data.frame(unique(data.1[, c("Plot_Name","EventDate",
                                               "PipeDirectionAzimuth")]))
  
  #get plotList
  plotList<-unique(position.df$Plot_Name)
  
  positionFactor.save<-list()
  for(i in 1:length(plotList)){
    position.df.sub<-subset(position.df, Plot_Name==plotList[i])
    #get unique postions
    unique.positions<-unique(position.df.sub$PipeDirectionAzimuth)
    
    positionFactor.df<-data.frame("PipeDirectionAzimuth" =unique.positions, 
                                  "Position_Name"=c("A","B","C","D"))
    
    #merge
    position.df.merge<-merge(position.df.sub, positionFactor.df, 
                             by="PipeDirectionAzimuth",all.x=TRUE)
    
    positionFactor.save<-rbind(positionFactor.save, position.df.merge)
    
  }
  
  #now merge back with data.1
  data.1<-merge(data.1, positionFactor.save, by=c("Plot_Name","EventDate",
                                                  "PipeDirectionAzimuth"), 
                all.x=TRUE)
  
  #change Position_Name to character string
  data.1$Position_Name<-as.character(data.1$Position_Name)

  #change PinPosition to character string
  data.1$PinPosition<-as.character(data.1$PinPosition)
  
  #Add Year, Month, and Day columns to data.
  message("Adding year, month, and day columns to data.")
  date.data<-data.frame(EventDate=data.1$EventDate)
  date.data$EventDate<-as.character(date.data$EventDate)
  date.string<-read.table(text=as.character(date.data$EventDate), sep="/",
                          colClasses = "character")
  colnames(date.string)<-c("Month","Day","Year")
  date.string$Year<-as.factor(date.string$Year)

  date.string$new.date<-as.Date(as.character(paste(date.string$Year,
                                                   date.string$Month,
                                                   date.string$Day,sep="-"),
                                             format = "%Y-%b-%d"))
  #Make column for ordinal day.
  date.string$ord.Day <- as.integer(format(date.string$new.date, "%j"))

  #Compile data
  data.2<-cbind(data.1,date.string)

  ########################################################################

  #Fix names that can be confusing when defining file paths, by replacing 
  #any "/" with "-" to not confuse with filepath definitions
    #data.2$Plot_Name<-gsub("/","-",as.character(data.2$Plot_Name))
  
  #Create new columns for "station.position.year", "station.year", 
  #and "station.year.day", using paste() function.
  data.2$station.position.year<-paste(data.2$Plot_Name, data.2$Position_Name, 
                                      data.2$Year,sep=".")
  data.2$station.year<-as.factor(paste(data.2$Plot_Name, data.2$Year,sep="."))
  data.2$station.year.ord.day<-as.factor(paste(data.2$Plot_Name, data.2$Year, 
                                               data.2$ord.Day,sep="."))
  #View first few rows of data.frame.
  head(data.2)

  #Create column for visits by each factor level of SET stations (Plot_Name).
  #Use 'data.table' package to add sequential visit numbers by each factor 
  #(i.e., Plot_Name)
  
  #Truncate data.frame
  data.1.events<-data.2[,c("Plot_Name","Year","Month","Day","ord.Day","station.year",
                           "station.year.ord.day")]

  #Convert from data.frame to data.table
  data.1.events<- as.data.table(unique(data.1.events))

  #Get the maximum number of visits to each SET per year.
  max.visits<-max(table(data.1.events$station.year, data.1.events$Year))
  max.visits

  #order
  data.1.events$Plot_Name<-as.character(data.1.events$Plot_Name)
  data.1.events<-data.1.events[order(data.1.events$Plot_Name, data.1.events$Year, 
                                     data.1.events$ord.Day)]
  
  #Sequentially order visits by a factor. NEED TO CHECK THIS
  data.1.events[, Visit := 1:.N, by = station.year]
  
  #Convert back to data.frame
  data.1.events<-as.data.frame(data.1.events)

  #Take a peek at first 6 rows.
  #head(data.1.events)

  #Now merge visits back with data.
  data.1.events<-data.1.events[,c("station.year.ord.day","Visit")]
  data.1.merge<-merge(data.2,data.1.events, by="station.year.ord.day",all.x=TRUE)

  #Take a look.
  head(data.1.merge)

  #Redefine data as 'data.out'.
  data.out<-as.data.frame(data.1.merge)
  
  #create two-digit number for zero (if nchar=1, prepend zero)
  data.out$VisitPad<-ifelse(nchar(as.character(data.out$Visit))<2, 
                              paste("0",as.character(data.out$Visit),sep=""),
                              as.character(data.out$Visit))
  
  
  
  data.out$year.visit<-paste(data.out$Year, data.out$VisitPad,sep=".")
  head(data.out)
  
  ##############################################################################
  #check that each station has more than 1 visit
  message("Checking data for inconsistencies.")
  check.data<-aggregate(year.visit~Plot_Name, data=data.out, 
                        FUN=function(x){length(unique(x))})
  check.data$enoughVisits<-ifelse(check.data[,2]>1,"Yes","NO")
  
  #remove any plots with only 1 year.visit
  check.data.keep<-check.data[check.data$enoughVisits!="NO",]
  
  #subset data out by list of check.data.keep
  keepPlots<-unique(as.character(check.data.keep$Plot_Name))
  
  data.out$Plot_Name<-as.character(data.out$Plot_Name)
  data.out.keep<-data.out[data.out$Plot_Name %in% keepPlots,]
  data.out.keep$Plot_Name<-as.factor(as.character(data.out.keep$Plot_Name))
  
  #check if each has all arm data
  message("Checking to ensure SET arm data looks good.")
  check.arms<-aggregate(Position_Name~Plot_Name, data=data.out.keep, 
                        FUN=function(x){length(unique(x))})
  check.arms$all4<-ifelse(check.arms[,2]==4,"Yes","NO")
  
  #remove FC02 due to missing data
  #data.out.keep<-subset(data.out.keep, Plot_Name!="FC02")
  #data.out.keep<-data.out.keep[complete.cases(data.out.keep),]
  
  names(data.out.keep)
  
  unique(data.out.keep$Refuge)
  
  unique(data.out.keep$RefugeName)
  
  #fix NWR names
  #remove "National Wildlife Refuge" from RefugeName
  data.out.keep$RefugeName<-trimws(gsub("National Wildlife Refuge","",
                                        gsub("National Wildlife Refuges","",
                                             data.out.keep$Refuge)))
  
  #remove "NWR" from Site_Name
  data.out.keep$Site_Name<-trimws(gsub("NWR","",data.out.keep$Site_Name))
  
  
  ##############################################################################
  #Use package 'reshape' to reorganize data (like Pivot table in Excel) using melt().
  message("Computing elevation change (mm) for SET data. . .")
  #melt function .
    data.melt<-reshape2::melt(data.out.keep, id=c("RefugeName","Plot_Name",
                                                  "ReaderFullName","Year",
                                                  "Position_Name",
                                                  "PipeDirectionAzimuth",
                                                  "PinPosition","Visit",
                                                  "year.visit"),
                    measure=c("PinHeight_mm"))

  ###################################################################
    #Generate lists 
      
    #Get stationList. (FYI, using the "<<-" sign puts object into the 
    #Global Environment).
    
    stationList<-unique(as.character(data.melt$Plot_Name))

    #Get yearList from data.
    yearList<-unique(as.character(data.melt$Year))

    #Get visitList from data.
    visitList<-unique(as.character(data.melt$Visit))

    #Get positionList.
    positionList<-unique(as.character(data.melt$Position_Name))

    #Get pinList from data.
    pinList<-unique(as.character(data.melt$PinPosition))

    #Create deltaPinList.
    deltaPinList<-c("deltaPin1","deltaPin2","deltaPin3","deltaPin4",
                    "deltaPin5","deltaPin6","deltaPin7","deltaPin8","deltaPin9")
  
    ###################################################################
  
    #Compute change in marsh height between ti and t0
    station.out<-list()
    for(k in 1:length(stationList)){
      #print(stationList[k])
      station.data<-subset(data.melt, Plot_Name==stationList[k])
      station.name<-unique(as.character(station.data$Plot_Name))
      
      position.out<-list()
      for(j in 1:length(positionList)){
        position.data<-NULL
        position.data<-subset(station.data, Position_Name==positionList[j])
        position.name<-unique(as.character(position.data$Position_Name))
        #position.data$year.visit<-as.numeric(position.data$year.visit)
        
          #now cast
          cast.data<-cast(position.data, PinPosition~year.visit+variable, 
                          fun.aggregate="max")
          
          #get length of total visits
          nVisits<-length(colnames(cast.data))-1
          
          #now get deltas
          all.delta.list<-list()
          for (i in 1:9){
            #print(i)
            sub.data<-cast.data[i,-1]

            delta.list<-list()
            for(p in 1:nVisits){
              #print(p)
              delta.list[p]<-sub.data[,p] - sub.data[,1]
            }
            
            delta.out<-as.data.frame(delta.list)
            colnames(delta.out)<-colnames(sub.data)
          
          all.delta.list<-rbind(all.delta.list, delta.out)
          }
          
          #transpose raw values
          cast.data.trans<-as.data.frame(as.matrix(t(cast.data)))
          
          #transpose deltas
          all.delta.trans<-as.data.frame(t(all.delta.list))
          
          #add pin column headers back in
          colnames(all.delta.trans)<-c("deltaPin1","deltaPin2","deltaPin3",
                                       "deltaPin4","deltaPin5","deltaPin6",
                                       "deltaPin7", "deltaPin8","deltaPin9")
          
          pin.df<-cbind(cast.data.trans, all.delta.trans)
          
          #add year.visit back in 
          pin.df$year.visit<-gsub("_PinHeight_mm","",row.names(pin.df))
          row.names(pin.df)<-NULL
          
          #add position back in 
          pin.df$Position_Name<-position.name
          
          #gather deltas for each postion
          position.out<-rbind(position.out, pin.df)
          
        }
          
          #add station name
        position.out$Plot_Name<-station.name
        
        #gather station deltas
        station.out<-rbind(station.out, position.out)
        
    }       
###################################################################
#combine deltas with all data
station.out$Plot_Year_Visit_Position<-paste(station.out$Plot_Name, 
                                            station.out$year.visit, 
                                            station.out$Position_Name, sep=".")
#remove columns
station.out$year.visit<-NULL
station.out$Plot_Name<-NULL
station.out$Position_Name<-NULL

#trim data.out.keep to include only needed columns
names(data.out.keep)

#need to merge with event data 
data.out.keep$Plot_Year_Visit_Position<-paste(data.out.keep$Plot_Name, 
                                              data.out.keep$year.visit, 
                                              data.out.keep$Position_Name, 
                                              sep=".")

data.out.keep.1<-unique(data.out.keep[,c("RefugeName","Site_Name","Plot_Name",
                                  "EventDate","Year","Month","Day","ord.Day","Visit",
                                  "year.visit","ReaderFullName","ReaderID",
                                  "PipeDirectionAzimuth","Position_Name",
                                  "Plot_Year_Visit_Position")])

new.data.out.1<-unique(merge(station.out, data.out.keep.1, 
                             by=c("Plot_Year_Visit_Position"),all.x=TRUE))

\###################################################################
#Read in R4_SET to get location info

#add Lat/Long if needed to rawData
SETcoords.1<-read.csv(file="/Users/zach/Dropbox (ZachTeam)/Projects/SET_USFWS_Region_4/
                      Reports/RMarkdown_pdf/Data/SET_Station_coords_all.csv", header=TRUE)

SETstates<-read.csv(file="/Users/zach/Dropbox (ZachTeam)/Projects/SET_USFWS_Region_4/
                    Reports/RMarkdown_pdf/Data/R4_SET.csv",header=TRUE)

SETstates.sub<-unique(SETstates[,c("State","Refuge")])

#merge with SETcoords
SETcoords<-merge(SETcoords.1, SETstates.sub,by="Refuge",all.x=TRUE)

R4_coords<-subset(SETcoords, RegionNumber==4)
R4_coords.sub<-unique(R4_coords[,c("State","StationName","StationLatitude",
                                   "StationLongitude")])
colnames(R4_coords.sub)<-c("State","Plot_Name","Latitude","Longitude")

#Merge new.data.out.1 and Region.lookup.
#new.data.out.2<-merge(new.data.out.1, Region.lookup, by="Unit_Code",all.x=TRUE)
new.data.out.2<-new.data.out.1

  #Add Longitude and Latitude coords for making maps.
  message("Adding State and Lat/Long coords for SET stations to data.")

  XYdata<-R4_coords.sub

  #Merge new.data.out with XYdata.
  data.out.3<-merge(new.data.out.2, XYdata, by="Plot_Name",all.x=TRUE)
  
  #Save data (as a .csv file).
  message("Saving SET with delta height data to .csv file.")
  write.csv(data.out.3, file=paste(myDir,"Data",
                                   paste(paste("All_R4_SET_data_formatted_",
                                               Sys.Date(),sep=""),"csv",sep="."),
                                   sep="/"),row.names=FALSE)

  ####################################################################
  #Create and save melted data.frame.

  #Redefine data as 'set.data'
  set.data<-as.data.frame(data.out.3)
  
  #create Date column
  set.data$Date<-as.Date(set.data$EventDate, tryFormats = c("%m-%d-%Y", "%m/%d/%Y"))
  
  set.delta.data<-set.data[,c("State","RefugeName","Site_Name","Plot_Name",
                              "Date","EventDate","Year","Month","Day","ord.Day",
                              "Visit","year.visit","ReaderFullName","ReaderID",
                              "PipeDirectionAzimuth","Position_Name",
                              "Plot_Year_Visit_Position","Longitude","Latitude",
                              "deltaPin1","deltaPin2","deltaPin3","deltaPin4",
                              "deltaPin5","deltaPin6","deltaPin7","deltaPin8",
                              "deltaPin9")]

  #Rename columns.
  colnames(set.delta.data)<-c("State","RefugeName","Site_Name","Plot_Name",
                              "Date","EventDate","Year","Month","Day","ord.Day", "Visit","year.visit","ReaderFullName","ReaderID","PipeDirectionAzimuth",
                              "Position_Name","Plot_Year_Visit_Position",
                              "Longitude","Latitude","Pin1","Pin2","Pin3",
                              "Pin4","Pin5","Pin6","Pin7","Pin8","Pin9")
  
  #Melt data to stack all Pins (Pin1, Pin2, . . .) in one column.
  delta.set.melt<-reshape2::melt(set.delta.data, id=c("State","RefugeName",
                                                      "Site_Name","Plot_Name",
                                                      "Date","EventDate","Year",
                                                      "Month","Day","ord.Day", 
                                                      "Visit","year.visit",
                                                      "ReaderFullName","ReaderID",
                                                      "PipeDirectionAzimuth",
                                                      "Position_Name",
                                                      "Plot_Year_Visit_Position",
                                                      "Longitude","Latitude"),
                     measure=c("Pin1","Pin2","Pin3","Pin4","Pin5","Pin6","Pin7",
                               "Pin8","Pin9"))

  #Add pos.pin column using paste()
  delta.set.melt$pos.pin<-paste(delta.set.melt$Position_Name, 
                                delta.set.melt$variable,sep="_")

#convert -Inf and Inf to NAs
  delta.set.melt$value<-ifelse(delta.set.melt$value==-Inf,NA,
                               ifelse(delta.set.melt$value==Inf,NA,
                                      delta.set.melt$value))

  
  #Save file.
  message("Finalizing data and saving file.")
  write.csv(delta.set.melt, file=paste(myDir,"Data",
                                       paste(paste("R4_SET_formatted_data.melt", Sys.Date(),sep="_"),"csv",sep="."),sep="/"),row.names=FALSE)

  return(delta.set.melt)

}

```

\newpage

#### Function to compute SET trends.
\  

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}

computeTrends<-function(dataIn){

  set.data<-dataIn

  #get list of unique NWRs
  refugeList<-sort(unique(as.character(set.data$RefugeName)))
  
  all.pins<-list()
  all.positions<-list()
  all.stations<-list()
  all.sites<-list()
  all.refuges<-list()
  for(j in 1:length(refugeList)){
  
    #print refuge to show progress
    print(refugeList[j])
    
    refuge.data<-subset(set.data,RefugeName==refugeList[j])
    
    #get refugeName
    refugeName<-as.character(unique(refuge.data$RefugeName))
    
    #get siteList
    siteList<-sort(unique(as.character(refuge.data$Site_Name)))
    
    refuge.pins<-list()
    refuge.positions<-list()
    refuge.stations<-list()
    refuge.sites<-list()
    for(k in 1:length(siteList)){
      
      site.data<-subset(refuge.data, Site_Name==siteList[k])
      
      siteName<-as.character(unique(site.data$Site_Name))
      
      #print Site_Name to show progress
      print(siteName)
      
      #get stationList
      stationList<-sort(unique(as.character(site.data$Plot_Name)))
      
      #get refuge covariates
      refugeCovs<-unique(site.data[,c("State","RefugeName",
                                      "Site_Name","Plot_Name",
                                      "Latitude","Longitude")])
      
      #get siteCovs
      siteCovs<-unique(site.data[,c("State","RefugeName","Site_Name")])
      
      site.pin.slopes<-list()
      site.positions<-list()
      site.stations<-list()
      for(i in 1:length(stationList)){
        #print(stationList[i])
        
        #print Plot_Name (Station) to show progress
        print(stationList[i])
        
        new.data<-subset(site.data, Plot_Name==stationList[i])
        
        stationName<-as.character(unique(new.data$Plot_Name))
        
        #get pospinList
        pospinList<-unique(sort(as.character(new.data$pos.pin)))
        
        #get covariates
        stationCovs<-unique(new.data[,c("State","RefugeName","Site_Name",
                                        "Plot_Name", "Latitude","Longitude")])
        
        positionCovs<-unique(new.data[,c("State","RefugeName","Site_Name",
                                         "Plot_Name","Position_Name","Latitude",
                                         "Longitude")])
        
        message("Getting slope and intercept from delta at each pin vs. 
                time regressions.")
        regResults.out<-list()
        for(k in 1:length(pospinList)){
          #print(pospinList[k])
          sub.data<-subset(new.data, pos.pin==pospinList[k])
          sub.data$value<-as.numeric(sub.data[,"value"])
          sub.data$ReaderFullName<-as.factor(as.character(sub.data$ReaderFullName))
          sub.dataCovs<-unique(sub.data[,c("State","RefugeName","Site_Name","Plot_Name",
                                           "Position_Name","variable","pos.pin")])
          
          #linear model with Visit nested within Year, and if there is only 1 visit, 
          #fit just Year, force linear model through origin 0
          mod.1<-tryCatch({
            lm(value ~ Year, data=sub.data)
          },error=function(cond2){
            cond2=NA
          })
          
          #get slope over years
          slope<-NULL
          try(slope<-coef(summary(mod.1))[ , "Estimate"][2])
          intercept<-NULL
          try(intercept<-coef(summary(mod.1))[ , "Estimate"][1])
          
          #combine slope with station covs
          regResults<-NULL
          regResults<-tryCatch({
            data.frame(sub.dataCovs,slope=slope,intercept=intercept)
          },error=function(cond2){
            cond2=data.frame(sub.dataCovs,slope=NA,intercept=NA)
            cond2
          })
          
          #compile regResults over each pin
          regResults.out<-rbind(regResults.out, regResults)
        }
        
        #get means for each position
        station.positions<-summaryFunction(dataIn=regResults.out, factor="Position_Name", 
                                           response="slope")
        station.positions.out.1<-merge(station.positions, positionCovs, by="Position_Name")
        station.positions.out<-station.positions.out.1[,c("State","RefugeName","Site_Name",
                                                        "Plot_Name","Latitude","Longitude",
                                                        "Position_Name","n","mean","var",
                                                        "SD", "SE","CV","lwr","upr")]
        
        #get station means
        station.slopes<-summaryFunction(dataIn=station.positions.out, factor="Plot_Name",
                                        response="mean")
        station.merge.1<-merge(station.slopes, refugeCovs, by="Plot_Name")
        station.merge<-station.merge.1[,c("State","RefugeName","Site_Name","Plot_Name",
                                          "Latitude","Longitude", "n","mean","var","SD",
                                          "SE","CV","lwr","upr")]
        
        #compile pin-level slopes for each site
        site.pin.slopes<-rbind(site.pin.slopes,regResults.out)
        
        #compile position means
        site.positions<-rbind(site.positions,station.positions.out)
        
        #compile station means
        site.stations<-rbind(site.stations, station.merge)
      }
      
      #get site means
      site.slopes<-summaryFunction(dataIn=site.stations, factor="Site_Name",
                                   response="mean")
      site.merge.1<-merge(site.slopes, siteCovs, by="Site_Name")
      site.merge<-site.merge.1[,c("State","RefugeName","Site_Name", "n","mean","var","SD",
                                  "SE","CV","lwr","upr")]
      
      refuge.pins<-rbind(refuge.pins,site.pin.slopes)
  
      refuge.positions<-rbind(refuge.positions,site.positions)
  
      refuge.stations<-rbind(refuge.stations, site.stations)
  
      refuge.sites<-rbind(refuge.sites, site.merge)
      
      #get refuge-level means
      refuge.slopes<-summaryFunction(dataIn=refuge.stations, factor="RefugeName",
                                     response="mean")
      refuge.merge.1<-merge(refuge.slopes, sub.dataCovs, by="RefugeName")
      refuge.merge<-refuge.merge.1[,c("State","RefugeName", "n","mean","var","SD",
                                      "SE","CV","lwr","upr")]
    }
  
    #compile all results
    all.pins<-rbind(all.pins, refuge.pins)
    
    all.positions<-rbind(all.positions, refuge.positions)
    
    all.stations<-rbind(all.stations, refuge.stations)
    
    all.sites<-rbind(all.sites, refuge.sites)
    
    all.refuges<-rbind(all.refuges,refuge.merge )
    
  }
  
all.pins<<-all.pins
all.positions<<-all.positions
all.stations<<-all.stations
all.sites<<-all.sites
all.refuges<<-all.refuges
}

```

\newpage

#### Convenience function for getting summary statistics.
\  

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}

#summary function creates table of n, mean, var, SD, and SE
summaryFunction <- function(dataIn, factor, response){
  summaryOut <- ddply(dataIn, factor, .fun = function(xx){
    c(n = length(xx[,response]),
      mean = mean(xx[,response],na.rm=TRUE),
      var = var(xx[,response],na.rm=TRUE),
      SD = sd(xx[,response],na.rm=TRUE),
      SE = sqrt(var(xx[,response],na.rm=TRUE)/length(xx[,response])),
      CV = sd(xx[,response],na.rm=TRUE)/mean(xx[,response],na.rm=TRUE),
      lwr = mean(xx[,response],na.rm=TRUE)-sqrt(var(xx[,response],na.rm=TRUE)/
                                                  length(xx[,response]))*1.96,
      upr = mean(xx[,response],na.rm=TRUE)+sqrt(var(xx[,response],na.rm=TRUE)/
                                                  length(xx[,response]))*1.96)
  })
  return(summaryOut)
  dev.off()
}

```

\newpage

### Appendix C. R code chunks used to analyze and produce all tables and figures from this report.
```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}

library(knitr)
library(rmdformats)
library(formatR)

## Global options
options(max.print="85")
opts_chunk$set(echo=FALSE,
               message=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               fig.align="center"
               )
opts_knit$set(width=80)
opts_knit$set(root.dir = '/Users/zach/Dropbox (ZachTeam)/Projects/
              SET_USFWS_Region_4/Reports/RMarkdown_pdf')

```


```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}

suppressMessages({

#load packages
library(httr)
library(markdown)
library(rmdformats)
library(stringr)
library(lme4)
library(lmerTest)
library(plyr)
library(reshape)
library(RColorBrewer)
library(colorRamps)
library(ggplot2)
library(ggrepel)
library(grid)
library(data.table)
library(lubridate)
library(ggmap)
library(scales)
library(spatstat)
library(ggsn)
library(data.table)
library(kableExtra)
library(ggpmisc)
library(xtable)
library(pander)
#library(shadowtext)

options(xtable.floating = FALSE)
options(xtable.timestamp = "")

#Load functions
message("Loading source files (these are all the functions).")
source("./R_source/summaryFunction.R")
source("./R_source/formatSETdataR4.R")
source("./R_source/computeTrends.R")

#register Google Maps API key
register_google(key="YOUR_GOOGLE_KEY_HERE")

})
```

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}

#build function to read in and combine data
combineData<-function(fileList){
  
  data.comb<-list()
  for(i in 1:length(fileList)){
    
    new.data<-read.csv(fileList[i],skip=3, header=TRUE)
    data.comb<-rbind(data.comb,new.data)
  }
return(data.comb) 
}

myFileList<-list.files("/Users/zach/Dropbox (ZachTeam)/Projects/
                       SET_USFWS_Region_4/Reports/RMarkdown_pdf/
                       Data/Refuge_Data_8-7-2020", full.names=TRUE)

data.comb<-combineData(fileList = myFileList)

#Export data
write.csv(data.comb, file="/Users/zach/Dropbox (ZachTeam)/
Projects/SET_USFWS_Region_4/Reports/RMarkdown_pdf/ Data/
Refuge_Data_8-7-2020.csv",row.names=FALSE)

```

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}
#read in raw data from USFWS SET database
rawData<-read.csv(file="/Users/zach/Dropbox (ZachTeam)/Projects/
SET_USFWS_Region_4/Reports/RMarkdown_pdf/Data/
Refuge_Data_8-7-2020.csv" , header=TRUE,as.is=TRUE)

```

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}

#my working dir
mydir<-"/Users/zach/Dropbox (ZachTeam)/Projects/SET_USFWS_Region_4/
Reports/RMarkdown_pdf"

#format data providing rawData object and mydir (a filepath 
#to a folder named "Data" where SET_coords.csv file is saved)
data.formatted<-try(formatSETdataR4(dataIn=rawData, dataDir=mydir))

```


```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}
#### Table 1. List of 22 sites among 19 US Fish and Wildlife 
#Service National Wildlife Refuge (NWR) units included in SET 
#data analyses along with corresponding State, count of SET stations, 
#count of unique observers, duration of years, and starting and ending 
#years of data collection. 

data<-data.formatted

#make Year an integer
data$Year<-as.integer(as.character(data$Year))

data.table.1<-unique(data[,c("State","RefugeName","Site_Name")])

#remove NAs
data.table.1<-data.table.1[complete.cases(data.table.1),]

#get freqency of SET stations per refuge
sub.data<-unique(data[,c("State","RefugeName","Site_Name","Plot_Name")])
count.stations<-table(sub.data$Site_Name, sub.data$Plot_Name)
count.stations.total<-rowSums(count.stations)
count.stations.total.1<-data.frame(Site_Name=names(count.stations.total), 
                                   N=as.data.frame(count.stations.total))

#get years sampled (start and end), and get number of observers
sub.data.years<-unique(data[,c("Site_Name","Year","ReaderFullName")])

#get refugeList
siteList<-unique(sort(as.character(sub.data.years$Site_Name)))

#loop over refugeList to get range of years per refuge
range.years<-list()
for(i in 1:length(siteList)){
  #subset data for 1 refuge
  new.data<-subset(sub.data.years,Site_Name==siteList[i])
  #get RefugeName
  siteName<-as.character(unique(new.data$Site_Name))
  #get starting year
  startYear<-min(new.data$Year)
  #get ending year
  endYear<-max(new.data$Year)
  #get total years
  nYears<-endYear-startYear
  #get n unique observers (data recorders)
  nObs<-length(unique(new.data$ReaderFullName))

  range.years.1<-data.frame(Site_Name=siteName, startYear=startYear, 
                            endYear=endYear, nYears=nYears,nObs=nObs)
  range.years<-rbind(range.years, range.years.1)

}

#combine with SummaryTable.1
data.table.2<-na.omit(merge(data.table.1, count.stations.total.1, 
                            by="Site_Name",all.x=TRUE))

#now combine with range.years
data.table.3<-merge(data.table.2, range.years, by="Site_Name")

#get Site order sorted North to South
siteLat<-aggregate(Latitude~Site_Name, data=data, FUN="mean")
siteOrder<-siteLat[order(siteLat$Latitude, decreasing = TRUE),]
siteOrderList<-unique(siteOrder$Site_Name)
#length(refugeOrderList)

#Now sort table by Latitude (reorder RefugeName factor)
#create data.frame with NWRs ordered from North to South
SiteOrder.df<-data.frame(Site=siteOrderList, 
                         orderNum=seq(1:length(siteOrderList)))

#rename column headers
colnames(data.table.3)<-c("Site", "State","Refuge","N",
                            "Start_Year","End_Year","Num_Years","Num_Obs")

#reorder columns
data.table.4<-data.table.3[,c("Site","State","Refuge","N","Num_Obs",
                              "Num_Years","Start_Year","End_Year")]

#create integer column of order for NWRs
data.table.order<-merge(data.table.4, SiteOrder.df, by=c("Site"),
                        all.x=TRUE)
data.table.order<-data.table.order[order(data.table.order$orderNum),]
data.table.5<-data.table.order
data.table.5$orderNum<-NULL

#remove row.names from table
row.names(data.table.5)<-NULL

#rename column headers
colnames(data.table.5)<-c("Site", "State","NWR","SETs (N)", 
                          "Observers (N)","Num. Years","Start Year",
                          "End Year")

panderOptions('table.alignment.default', function(df) {
  ifelse(sapply(df, is.numeric), 'right', 'left'))
}
panderOptions("table.split.table", Inf)

pander(data.table.5)

```

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}
#### Figure 1. Study Area showing sites (*N* = 22) where SET 
#benchmarks are located among 19 USFWS National Wildlife Refuges, 
#Southeast Region. 

#Map with study area locations

#get locations of SETs
SETcoords<-unique(data[, c("RefugeName","Site_Name","Plot_Name",
                           "Longitude","Latitude")])

#aggregate to get Site coords
site.long<-aggregate(Longitude~Site_Name+RefugeName, 
                     data=SETcoords, FUN=mean)
site.lat<-aggregate(Latitude~Site_Name+RefugeName, 
                    data=SETcoords, FUN=mean)
site.coords.merge<-merge(site.long, site.lat, 
                         by=c("Site_Name","RefugeName"),all=TRUE)

meanLong<-mean(SETcoords$Longitude)
meanLat<-mean(SETcoords$Latitude)

#get basemap
basemap<-get_map(location=c(meanLong, meanLat),zoom=6, 
                 maptype="terrain-background")
#ggmap(basemap)

#get map extent
mapExtent<-attr(basemap, "bb")


studyAreaMap<-ggmap(basemap)+
  geom_point(data=site.coords.merge, aes(x=Longitude, 
                                         y=Latitude),
             color="black",size=3)+
  labs(x="Longitude",y="Latitude")+
  theme(
    axis.text=element_text(size=18),
    axis.title=element_text(size=22),
    panel.border=element_rect(fill="transparent", color="black"),
    legend.position = "none")+
  geom_text_repel(data=site.coords.merge,aes(x=Longitude,y=Latitude, 
                                             label=Site_Name), 
                  show.legend=FALSE, size=4.5, segment.alpha=0.7,
                  color = "black", bg.color = "white", bg.r = 0.16)+
  guides(fill = guide_legend(title = "National Wildlife Refuge", label = FALSE))+
  ggsn::scalebar(x.min=mapExtent$ll.lon, x.max=mapExtent$ur.lon, 
                 y.min=mapExtent$ll.lat, y.max=mapExtent$ur.lat,transform=TRUE, 
                 dist_unit="km",dist=200, st.dist=0.015, height = 0.01,anchor=c(x=-73,y=28))

studyAreaMap

```

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}

#### Figure 2. Plot change in elevation data relative to initial 
#height (mm) over time for all pin-level SET data.

set.data.all<-data

  SETallDatesPlot<-ggplot(data=set.data.all, aes(x=Date, y=value, group=1))+
    geom_point(aes(color=value),alpha=0.7, size=1, shape=16)+
    scale_color_gradient2(low="tomato",mid="gray60",high="royalblue1", 
                          guide_colorbar(title="Delta Elev. (mm)"))+
    geom_smooth(method=lm, fullrange=TRUE, linetype=1, color="gray20", se=TRUE)+
    scale_y_continuous(expand=c(0.1,0.1))+
    scale_x_date(date_breaks = "1 year",date_labels = "%Y")+
        theme(panel.background = element_rect(color="black",fill="transparent"),
          panel.border = element_rect(color="black", fill="transparent"),
          axis.text.x = element_text(size=12, color="black"),
          axis.text.y = element_text(size=12, color="black"),
          axis.title.x = element_text(size=14, hjust=0.5, vjust=1.9),
          axis.title.y = element_text(angle = 90, vjust=1.2, size=14),
          legend.position = c(0.11,0.2),
          legend.key.size = unit(1,"line"))+
    geom_hline(yintercept=0, linetype=2, color="gray30",alpha=0.8)+
    stat_poly_eq(formula = y~ x, eq.with.lhs = "italic(hat(y))~`=`~",
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                 parse = TRUE)+
    labs(x="Year",y="Relative change in pin height (mm)")

  SETallDatesPlot
```

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}

#### Table 2. List of Locations with outliers (e.g., relative change in 
#height (mm) > 400 mm or < -400 mm)

set.data.findOutliers<-subset(set.data.all, c(value > 400 | value < -400))

#simplify
set.outliers<-set.data.findOutliers[,c("State","RefugeName","Site_Name",
                                       "Plot_Name","EventDate","Date",
                                       "PipeDirectionAzimuth","variable",
                                       "value")]

#get unique filtering term
set.outliers$Plot_Date_Arm_Pin<-paste(set.outliers$Plot_Name, 
                            set.outliers$EventDate,
                            set.outliers$PipeDirectionAzimuth,
                            set.outliers$variable, sep="_")

#bring in raw data to check for flags or comments?
rawData$Plot_Date_Arm_Pin<-paste(rawData$Plot_Name, 
                                 rawData$EventDate, rawData$PipeDirectionAzimuth, 
                                 paste("Pin",rawData$PinPosition,sep=""), sep="_")

#get list of outliers
outlierList<-unique(set.outliers$Plot_Date_Arm_Pin)

#subset rawData
rawData.outliers<-subset(rawData, Plot_Date_Arm_Pin %in% outlierList)

outliers.sub<-rawData.outliers[,c("Site_Name","Plot_Name","EventDate",
                                  "PipeDirectionAzimuth","PinPosition",
                                  "PinLength_mm","PinHeight_mm")]

row.names(outliers.sub)<-NULL

colnames(outliers.sub)<-c("Site","Plot","Date","Pipe Direction",
                          "Pin Position","Pin length (mm)",
                          "Pin height (mm)")

panderOptions('table.alignment.default', function(df) {
  ifelse(sapply(df, is.numeric), 'right', 'left'))
}
panderOptions("table.split.table", Inf)

pander(outliers.sub)

```

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}

#### Figure 3. Plot change in elevation data relative to initial 
#height (mm) over time for SET data without outliers.

set.data.noOutliers<-subset(set.data.all, c(value < 400 & value > -400))

  SETallDatesPlot_noOutliers<-ggplot(data=set.data.noOutliers, 
                                     aes(x=Date, y=value, group=1))+
    geom_point(aes(color=value),alpha=0.7, size=1, shape=16)+
    scale_color_gradient2(low="tomato",mid="gray60",high="royalblue1", 
                          guide_colorbar(title="Delta Elev. (mm)"))+
    #geom_path(aes(color=Plot_Name),alpha=0.2)+
    geom_smooth(method=lm, fullrange=TRUE, linetype=1, color="gray20", se=TRUE)+
    scale_y_continuous(expand=c(0.1,0.1))+
    scale_x_date(date_breaks = "1 year",date_labels = "%Y")+
        theme(panel.background = element_rect(color="black",fill="transparent"),
          panel.border = element_rect(color="black", fill="transparent"),
          axis.text.x = element_text(size=12, color="black"),
          axis.text.y = element_text(size=12, color="black"),
          axis.title.x = element_text(size=14, hjust=0.5, vjust=1.9),
          axis.title.y = element_text(angle = 90, vjust=1.2, size=14),
          legend.position = c(0.11,0.2),
          legend.key.size = unit(1,"line"))+
    geom_hline(yintercept=0, linetype=2, color="gray30",alpha=0.8)+
    stat_poly_eq(formula = y~ x,eq.with.lhs = "italic(hat(y))~`=`~",
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                 parse = TRUE)+
    labs(x="Year", y="Relative change in pin height (mm)")

  SETallDatesPlot_noOutliers

```

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}
### Function to compute SET trends.

computeTrends<-function(dataIn){

  set.data<-dataIn

  #get list of unique NWRs
  refugeList<-sort(unique(as.character(set.data$RefugeName)))
  
  all.pins<-list()
  all.positions<-list()
  all.stations<-list()
  all.sites<-list()
  all.refuges<-list()
  for(j in 1:length(refugeList)){
  
    #print refuge to show progress
    print(refugeList[j])
    
    refuge.data<-subset(set.data,RefugeName==refugeList[j])
    
    #get refugeName
    refugeName<-as.character(unique(refuge.data$RefugeName))
    
    #get siteList
    siteList<-sort(unique(as.character(refuge.data$Site_Name)))
    
    refuge.pins<-list()
    refuge.positions<-list()
    refuge.stations<-list()
    refuge.sites<-list()
    for(k in 1:length(siteList)){
      
      site.data<-subset(refuge.data, Site_Name==siteList[k])
      
      siteName<-as.character(unique(site.data$Site_Name))
      
      #print Site_Name to show progress
      print(siteName)
      
      #get stationList
      stationList<-sort(unique(as.character(site.data$Plot_Name)))
      
      #get refuge covariates
      refugeCovs<-unique(site.data[,c("State","RefugeName",
                                      "Site_Name","Plot_Name",
                                      "Latitude","Longitude")])
      
      #get siteCovs
      siteCovs<-unique(site.data[,c("State","RefugeName","Site_Name")])
      
      site.pin.slopes<-list()
      site.positions<-list()
      site.stations<-list()
      for(i in 1:length(stationList)){
        #print(stationList[i])
        
        #print Plot_Name (Station) to show progress
        print(stationList[i])
        
        new.data<-subset(site.data, Plot_Name==stationList[i])
        
        stationName<-as.character(unique(new.data$Plot_Name))
        
        #get pospinList
        pospinList<-unique(sort(as.character(new.data$pos.pin)))
        
        #get covariates
        stationCovs<-unique(new.data[,c("State","RefugeName","Site_Name",
                                        "Plot_Name", "Latitude","Longitude")])
        
        positionCovs<-unique(new.data[,c("State","RefugeName","Site_Name",
                                         "Plot_Name","Position_Name","Latitude",
                                         "Longitude")])
        
        message("Getting slope and intercept from delta at each pin vs. 
                time regressions.")
        regResults.out<-list()
        for(k in 1:length(pospinList)){
          #print(pospinList[k])
          sub.data<-subset(new.data, pos.pin==pospinList[k])
          sub.data$value<-as.numeric(sub.data[,"value"])
          sub.data$ReaderFullName<-as.factor(as.character(sub.data$ReaderFullName))
          sub.dataCovs<-unique(sub.data[,c("State","RefugeName","Site_Name","Plot_Name",
                                           "Position_Name","variable","pos.pin")])
          
          #linear model with Visit nested within Year, and if there is only 1 visit, 
          #fit just Year, force linear model through origin 0
          mod.1<-tryCatch({
            lm(value ~ Year, data=sub.data)
          },error=function(cond2){
            cond2=NA
          })
          
          #get slope over years
          slope<-NULL
          try(slope<-coef(summary(mod.1))[ , "Estimate"][2])
          intercept<-NULL
          try(intercept<-coef(summary(mod.1))[ , "Estimate"][1])
          
          #combine slope with station covs
          regResults<-NULL
          regResults<-tryCatch({
            data.frame(sub.dataCovs,slope=slope,intercept=intercept)
          },error=function(cond2){
            cond2=data.frame(sub.dataCovs,slope=NA,intercept=NA)
            cond2
          })
          
          #compile regResults over each pin
          regResults.out<-rbind(regResults.out, regResults)
        }
        
        #get means for each position
        station.positions<-summaryFunction(dataIn=regResults.out, factor="Position_Name", 
                                           response="slope")
        station.positions.out.1<-merge(station.positions, positionCovs, by="Position_Name")
        station.positions.out<-station.positions.out.1[,c("State","RefugeName","Site_Name",
                                                        "Plot_Name","Latitude","Longitude",
                                                        "Position_Name","n","mean","var",
                                                        "SD", "SE","CV","lwr","upr")]
        
        #get station means
        station.slopes<-summaryFunction(dataIn=station.positions.out, factor="Plot_Name",
                                        response="mean")
        station.merge.1<-merge(station.slopes, refugeCovs, by="Plot_Name")
        station.merge<-station.merge.1[,c("State","RefugeName","Site_Name","Plot_Name",
                                          "Latitude","Longitude", "n","mean","var","SD",
                                          "SE","CV","lwr","upr")]
        
        #compile pin-level slopes for each site
        site.pin.slopes<-rbind(site.pin.slopes,regResults.out)
        
        #compile position means
        site.positions<-rbind(site.positions,station.positions.out)
        
        #compile station means
        site.stations<-rbind(site.stations, station.merge)
      }
      
      #get site means
      site.slopes<-summaryFunction(dataIn=site.stations, factor="Site_Name",
                                   response="mean")
      site.merge.1<-merge(site.slopes, siteCovs, by="Site_Name")
      site.merge<-site.merge.1[,c("State","RefugeName","Site_Name", "n","mean","var","SD",
                                  "SE","CV","lwr","upr")]
      
      refuge.pins<-rbind(refuge.pins,site.pin.slopes)
  
      refuge.positions<-rbind(refuge.positions,site.positions)
  
      refuge.stations<-rbind(refuge.stations, site.stations)
  
      refuge.sites<-rbind(refuge.sites, site.merge)
      
      #get refuge-level means
      refuge.slopes<-summaryFunction(dataIn=refuge.stations, factor="RefugeName",
                                     response="mean")
      refuge.merge.1<-merge(refuge.slopes, sub.dataCovs, by="RefugeName")
      refuge.merge<-refuge.merge.1[,c("State","RefugeName", "n","mean","var","SD",
                                      "SE","CV","lwr","upr")]
    }
  
    #compile all results
    all.pins<-rbind(all.pins, refuge.pins)
    
    all.positions<-rbind(all.positions, refuge.positions)
    
    all.stations<-rbind(all.stations, refuge.stations)
    
    all.sites<-rbind(all.sites, refuge.sites)
    
    all.refuges<-rbind(all.refuges,refuge.merge )
    
  }
  
all.pins<<-all.pins
all.positions<<-all.positions
all.stations<<-all.stations
all.sites<<-all.sites
all.refuges<<-all.refuges
}

```

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}
#test computeTrends
computeTrends(dataIn=set.data.noOutliers)

```

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}
#### Figure 4. Plot change in elevation data relative to initial 
#height (mm) over time for all SET data.

# find significant trends: For this section we need to use the regress, 
# then average method, with no observer effects use values from 
# computeTrends() above 'all

stationList<-unique(set.data.noOutliers$Plot_Name)

station.sig.trends.out<-list()
for(i in 1:length(stationList)){
  
  #subset data
  new.station.data<-subset(set.data.noOutliers, Plot_Name==stationList[i])
  
  #fit simple linear regression model
  station.mod<-lm(value~Date, data=new.station.data)
  
  #get model summary stats
  mod.summary<-summary(station.mod)
  
  #create data.frame
  mod.summary.stats<-data.frame(Plot_Name=stationList[i],
                                t(mod.summary$coefficients[2,]))
  
  #add column indicating significance
  mod.summary.stats$Significant<-ifelse(mod.summary.stats$Pr...t.. <= 0.05,
                                        "Yes","No")
  
  #add column indicating direction of trend
  mod.summary.stats$Trend<-ifelse(mod.summary.stats$Estimate>0 ,
                                  "Positive","Negative")
  #compile station model results
  station.sig.trends.out<-rbind(station.sig.trends.out, mod.summary.stats)
}

#now merge these results back with set.data.noOutliers
set.data.merge<-merge(set.data.noOutliers, station.sig.trends.out, 
                      by="Plot_Name",all.x=TRUE)

#add sig.trend column
set.data.merge$Sig_Trend<-ifelse(set.data.merge$Significant=="Yes" & 
                                   set.data.merge$Trend=="Positive","Positive",
                                 ifelse(set.data.merge$Significant=="Yes" & 
                                          set.data.merge$Trend=="Negative",
                                        "Negative","Not Significant"))

#set factor level order for Sig_Trend
set.data.merge$Sig_Trend<-factor(set.data.merge$Sig_Trend, 
                                 levels=c("Positive","Not Significant",
                                          "Negative"))

mySigColors<-c("royalblue1","gray20","tomato")
mySigFills<-c(alpha("royalblue1",0.3), alpha("gray20",0.3),alpha("tomato",0.3))

  SETallDatesPlot_noOutliers<-ggplot(data=set.data.merge, 
                                     aes(x=Date, y=value, group=1))+
    geom_point(color="gray50",alpha=0.7, size=0.8, shape=16)+
    #geom_path(aes(color=Plot_Name),alpha=0.2)+
    geom_smooth(aes(color=Sig_Trend, fill=Sig_Trend),method=lm, 
                fullrange=TRUE, linetype=1, se=TRUE)+
    scale_color_manual(values=mySigColors)+
    scale_fill_manual(values=mySigFills)+
    scale_y_continuous(expand=c(0.1,0.1))+
    scale_x_date(date_breaks = "2 year",date_labels = "%Y")+
        theme(panel.background = element_rect(color="black",
                                              fill="transparent"),
          panel.border = element_rect(color="black", fill="transparent"),
          axis.text.x = element_text(size=10, color="black"),
          axis.text.y = element_text(size=10, color="black"),
          axis.title.x = element_text(size=12, hjust=0.5, vjust=1.9),
          axis.title.y = element_text(angle = 90, vjust=1.2, size=12),
          legend.position = "top",
          legend.key.size = unit(1,"line"),
          legend.text = element_text(size=10),
          legend.title=element_text(size=12),
          legend.background = element_rect(fill=alpha("white",0.9), color="black"))+
    geom_hline(yintercept=0, linetype=2, color="gray30",alpha=0.8)+
    stat_poly_eq(formula = y~ x,eq.with.lhs = "italic(hat(y))~`=`~",
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                 parse = TRUE, size=4)+
    labs(x="Year", y="Relative difference in pin height (mm)")


  
#try facet by SET
  SETallDatesPlot_noOutliers_Facet<-SETallDatesPlot_noOutliers+
    facet_wrap(~Plot_Name, scales="free", drop=TRUE, ncol=5)+
    theme(strip.text=element_text(size=13))

  SETallDatesPlot_noOutliers_Facet

```


```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}
#### Table 3. Site-level trend estimates mean, and upper and 
#lower 95% confidence intervals for change in wetland elevation (mm/year).

#get sorted RefugeName levels
refuge.order<-all.refuges[order(all.refuges$mean,decreasing=TRUE),]
refuge.order$RefugeName<-factor(refuge.order$RefugeName, 
                      levels=unique(as.character(refuge.order$RefugeName)))

site.order<-all.sites
#order by Latitude from SiteOrder.df
site.order$Site_Name<-factor(site.order$Site_Name, 
                             levels=unique(SiteOrder.df$Site),ordered = TRUE)
#levels(site.order$Site_Name)

site.order<-site.order[order(site.order$Site_Name,decreasing=FALSE),]

site.order.table<-site.order[,c("Site_Name","RefugeName","State",
                                "n","mean","SE","lwr","upr")]
colnames(site.order.table)<-c("Site","NWR","State","N","Mean","SE", 
                              "Lower 95% CI", "Upper 95% CI")

row.names(site.order.table)<-NULL

panderOptions('table.alignment.default', function(df) {
  ifelse(sapply(df, is.numeric), 'right', 'left'))
}
panderOptions("table.split.table", Inf)

pander(site.order.table)

```

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}
#### Figure 5. Site-level trend (mean $\pm$ SE) in change 
#in wetland elevation (mm/year).

#get sorted RefugeName levels
refuge.order<-all.refuges[order(all.refuges$mean,decreasing=TRUE),]
refuge.order$RefugeName<-factor(refuge.order$RefugeName, 
                          levels=unique(as.character(refuge.order$RefugeName)))

#sort by mean
site.order<-all.sites[order(all.sites$mean,decreasing=TRUE),]

site.order$RefugeName<- factor(site.order$RefugeName, 
                        levels=refuge.order$RefugeName[order(refuge.order$mean,
                                                             decreasing = TRUE)], 
                        ordered=TRUE)

#order by Site_Name
site.order$Site_Name<-factor(site.order$Site_Name, 
                      levels=site.order$Site_Name[order(site.order$RefugeName,
                                                          decreasing = FALSE)], 
                             ordered=TRUE)

site.trend.plot<-ggplot(data=site.order, aes(x=Site_Name, y=mean))+
  #coord_flip()+
  geom_bar(stat="identity",aes(fill=mean),alpha=0.9)+
  geom_errorbar(aes(ymin=mean-SE, ymax=mean+SE, color=mean),width=0, 
                show.legend=FALSE)+
  geom_hline(yintercept = 0, linetype=2, color=alpha("lightgray",0.8))+
  scale_color_gradient2(low="tomato",mid="gray60",high="royalblue1")+
  scale_fill_gradient2(low="tomato",mid="gray60",high="royalblue1")+
  theme(panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill="transparent",color="black"),
        axis.text.x=element_text(angle=90,  vjust=0.5, hjust=1),
        legend.position = c(0.08,0.22),
        legend.background = element_rect(fill = "white", 
                                         colour = "transparent"))+
  labs(y="Trend (mm/year)", x="Refuge", fill="Trend", color=NULL)

print(site.trend.plot)

```

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}
#### Figure 6. SET Station-level trend (mean $\pm$ SE) in 
#change in wetland elevation (mm/year).

#sort by mean
station.order<-all.stations[order(c(all.stations$mean),decreasing=TRUE),]
#order Station levels
station.order$Plot_Name<-factor(station.order$Plot_Name, 
                        levels=rev(unique(as.character(station.order$Plot_Name))))
#order Station levels
station.order$Site_Name<-factor(station.order$Site_Name, 
                        levels=rev(unique(as.character(station.order$Site_Name))))

#order by Refuge
station.order$RefugeName<-factor(station.order$RefugeName, 
                      levels=unique(as.character(refuge.order$RefugeName)))

#sort by mean
station.order<-all.stations[order(c(all.stations$mean),
                                  decreasing=TRUE),]

#get sorted RefugeName levels
refuge.order<-all.refuges[order(all.refuges$mean,decreasing=TRUE),]
refuge.order$RefugeName<-factor(refuge.order$RefugeName, 
                      levels=unique(as.character(refuge.order$RefugeName)))

#sort by mean
station.order<-all.stations[order(all.stations$mean,decreasing=TRUE),]

station.order$RefugeName<- factor(station.order$RefugeName, 
                      levels=refuge.order$RefugeName[order(refuge.order$mean,
                                                               decreasing = TRUE)], 
                          ordered=TRUE)

#order by Site_Name
station.order$Plot_Name<-factor(station.order$Plot_Name, 
                      levels=station.order$Plot_Name[order(station.order$RefugeName,
                                                  decreasing = FALSE)], ordered=TRUE)

station.trend.plot<-ggplot(data=station.order, aes(x=Plot_Name, y=mean))+
  geom_bar(stat="identity",aes(fill=mean),alpha=0.9)+
  geom_errorbar(aes(ymin=mean-SE, ymax=mean+SE, color=mean),width=0, 
                show.legend=FALSE)+
  geom_hline(yintercept = 0, linetype=2, color=alpha("lightgray",0.8))+
  scale_color_gradient2(low="tomato",mid="gray60",high="royalblue1")+
  scale_fill_gradient2(low="tomato",mid="gray60",high="royalblue1")+
  theme(panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill="transparent",color="black"),
        axis.text.x=element_text(angle=90,  vjust=0.5, hjust=1, size=5),
        legend.position = c(0.08,0.22),
        legend.background = element_rect(fill = "white", colour = "transparent"))+
  labs(y="Trend (mm/year)", x="SET Station Name", fill="Trend", color=NULL)

print(station.trend.plot)

```

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}
#### Figure 7. Regional map showing site-level trends.

#Map with study area locations

#get locations of SETs
SETcoords<-unique(data[, c("RefugeName","Site_Name","Plot_Name",
                           "Longitude","Latitude")])

#aggregate to get Site coords
site.long<-aggregate(Longitude~Site_Name+RefugeName, data=SETcoords, 
                     FUN=mean)
site.lat<-aggregate(Latitude~Site_Name+RefugeName, data=SETcoords, 
                    FUN=mean)
site.coords.merge<-merge(site.long, site.lat, 
                         by=c("Site_Name","RefugeName"),all=TRUE)

#merge with site-level means
site.order.merge<-merge(site.order, site.coords.merge,
                        by=c("Site_Name","RefugeName"),all.x=TRUE)

#add magnitude column with multiple
site.order.merge$Magnitude<-abs(site.order.merge$mean)

meanLong<-mean(SETcoords$Longitude)
meanLat<-mean(SETcoords$Latitude)

#get basemap
meanLong<-mean(SETcoords$Longitude)
meanLat<-mean(SETcoords$Latitude)

#get basemap
basemap<-get_map(location=c(meanLong, meanLat),zoom=6, 
                 maptype="satellite")
#ggmap(basemap)

#get map extent
mapExtent<-attr(basemap, "bb")


trendMapRegion<-ggmap(basemap,darken = c(0.3, "gray20"))+
  geom_point(data=site.order.merge, aes(x=Longitude, y=Latitude, 
                                        color=mean), 
             size=4,alpha=0.8, position=position_jitter(width=0.1, 
                                                        height=0.1))+
  scale_color_gradient2(low="tomato",mid="gray60",high="royalblue1", 
                        guide_colorbar(title="Trend (mm/year)"))+
  labs(x="Longitude",y="Latitude")+
  theme(
    axis.text=element_text(size=14),
    axis.title=element_text(size=16),
    panel.border=element_rect(fill="transparent", color="black"),
    #legend.position = "none"
    legend.position = c(0.8,0.23),
    legend.key.size = unit(2,"line"),
    legend.text = element_text(size=12, color="white"),
    legend.title=element_text(size=14, color="white"),
    legend.background = element_rect(fill="transparent")
  )+
    geom_text_repel(data=site.order.merge,aes(x=Longitude,y=Latitude, 
                                              label=Site_Name, color=mean), 
                    show.legend=FALSE, size=4.5, segment.alpha=0.7,
                  bg.color = "white", bg.r = 0.16)+
  ggsn::scalebar(x.min=mapExtent$ll.lon, x.max=mapExtent$ur.lon, 
                 y.min=mapExtent$ll.lat, y.max=mapExtent$ur.lat,transform=TRUE, 
                 dist_unit="km",dist=200, st.dist=0.015, height = 0.01,
                 anchor=c(x=-73,y=28),st.color = "white")

trendMapRegion

```


```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}
### Station-level summaries showing map of SET stations with trends, 
#and station-level trend plots.

#subchunkify function to produce figures of differing dimmensions 
#within the same r chunk
subchunkify <- function(g, fig_height=6, fig_width=4) {
  g_deparsed <- paste0(deparse(
    function() {g}
  ), collapse = '')
  
  sub_chunk <- paste0("
  `","``{r sub_chunk_", floor(runif(1) * 10000), ", fig.height=", 
  fig_height, ", fig.width=", fig_width, ", echo=FALSE}",
  "\n(", 
    g_deparsed
    , ")()",
  "\n`","``
  ")
  
  cat(knitr::knit(text = knitr::knit_expand(text = sub_chunk), 
                  quiet = TRUE))
}

#function to wrap long titles 
wrapper <- function(x, ...) 
{
  paste(strwrap(x, ...), collapse = "\n")
}

#get site-level means
siteList<-unique(station.order$Site_Name)

for(i in 1:length(siteList)){
  
  #get locations of SETs
  new.SETcoords<-subset(station.order, Site_Name==siteList[i])
  
  #get site sampling info
  site.sampling.info<-subset(data.table.5, Site==siteList[i])
  
  #get site name
  siteName<-as.character(unique(new.SETcoords$Site_Name))
  
  #get refugeName
  refugeName<-as.character(unique(new.SETcoords$RefugeName))
  
  #get overall, site-level mean
  site.mean.df<-subset(site.order, Site_Name==siteList[i])
  
  #aggregate to get Site coords
  site.long<-aggregate(Longitude~Site_Name+RefugeName, 
                       data=new.SETcoords, FUN=mean)
  site.lat<-aggregate(Latitude~Site_Name+RefugeName, 
                      data=new.SETcoords, FUN=mean)
  
  meanLong<-mean(new.SETcoords$Longitude)
  meanLat<-mean(new.SETcoords$Latitude)

  left.coord=meanLong- (meanLong-min(new.SETcoords$Longitude))
  bottom.coord=meanLat-(meanLat-min(new.SETcoords$Latitude))
  right.coord=meanLong+(max(new.SETcoords$Longitude)-meanLong)
  top.coord=meanLat+(max(new.SETcoords$Latitude)-meanLat)
  
  #set zoom 
  plotZoom=ifelse(siteName=="Harris Neck", 11, 
                  ifelse(siteName=="Cape Romain - Horsehead Key",14,17))

  #scale location multiple
  plotScaleAnchorX=ifelse(siteName=="Cape Romain - Horsehead Key",0.99983, 
                          ifelse(siteName=="Harris Neck",0.998,0.99993))
  plotScaleAnchorY=ifelse(siteName=="Cape Romain - Horsehead Key",0.99975, 
                          ifelse(siteName=="Harris Neck",0.99641,0.999935))
  
  #scalebarDist
  scalebarDist=ifelse(siteName=="Harris Neck",5, 0.3)
  
  #get basemap
  basemap<-get_map(location=c(lon=meanLong, lat=meanLat),zoom=plotZoom, 
                   maptype="satellite")
#ggmap(basemap)
  
  #get map extent
  mapExtent<-attr(basemap, "bb")

trendMapSite<-ggmap(basemap,darken = c(0.2, "gray10"))+
  geom_point(data=new.SETcoords, aes(x=Longitude, y=Latitude, color=mean), 
             size=4,alpha=0.9)+
  scale_color_gradient2(low="tomato",mid="gray60",high="royalblue1",
                        limits=c(min(station.order$mean,na.rm=TRUE),
                                 max(station.order$mean, na.rm=TRUE)), 
                        guide_colorbar(title="Trend\n(mm/year)"))+
  #scale_size_binned(range=c(4,30))+
  labs(x="Longitude",y="Latitude")+
  theme(
    axis.text=element_text(size=10),
    axis.title=element_text(size=12),
    title=element_text(size=11),
    panel.border=element_rect(fill="transparent", color="black"),
    #legend.position = "none"
    legend.position = c(0.15,0.82),
    legend.key.size = unit(0.7,"line"),
    legend.text = element_text(size=8, color="white"),
    legend.title=element_text(size=10, color="white"),
    legend.background = element_rect(fill="transparent")
  )+
  geom_label_repel(data=new.SETcoords,aes(x=Longitude,y=Latitude, label=Plot_Name), 
                   fill="white",color="black", show.legend=FALSE,point.padding=0.8, 
                   label.padding=0.4, size=4, segment.alpha=0.7, alpha=0.8)+
  ggsn::scalebar(x.min=mapExtent$ll.lon, x.max=mapExtent$ur.lon, 
                 y.min=mapExtent$ll.lat, y.max=mapExtent$ur.lat,transform=TRUE, 
                 dist_unit="km",dist=scalebarDist, st.dist=0.02, 
                 st.size=3,height = 0.01,st.color = "white", anchor=c(x=right.coord*plotScaleAnchorX,y=bottom.coord*plotScaleAnchorY))+
  ggtitle(wrapper("A) Locations of SET stations showing elevation trends (mm/year).",
                  width=50))

#add blank lines
#cat("\\newline")

#make pos.pin a factor
set.data.merge$pos.pin<-as.factor(set.data.merge$pos.pin)

#make column with colors
set.data.merge$trendColor<-ifelse(set.data.merge$Sig_Trend=="Positive","royalblue2",
                           ifelse(set.data.merge$Sig_Trend=="Negative","tomato","gray20"))

#set factor levels for trendColor
plot.data<-subset(set.data.merge, Site_Name==siteName)

#get site level trend by regressing station-level means

  #fit simple linear regression model
  site.mod<-lm(value~Date, data=plot.data)
  
  #get model summary stats
  site.mod.summary<-summary(site.mod)
  
  #create data.frame
  site.mod.summary.stats<-data.frame(Plot_Name=siteList[i],
                                     t(site.mod.summary$coefficients[2,]))
  
  #add column indicating significance
  site.mod.summary.stats$Significant<-ifelse(site.mod.summary.stats$Pr...t.. <= 0.05,
                                             "Yes","No")
  
  #add column indicating direction of trend
  site.mod.summary.stats$Trend<-ifelse(site.mod.summary.stats$Estimate>0 ,
                                       "Positive","Negative")
  

#site-level sig. trend
plot.data$Site_Sig_Trend<-site.mod.summary.stats$Trend

#site-level significant trends factors
plot.data$Site_Sig_Trend<-factor(plot.data$Site_Sig_Trend, 
                                 levels=c("Positive","Not Significant","Negative"))

  
#station-level significant trends factors
plot.data$Sig_Trend<-factor(plot.data$Sig_Trend, 
                            levels=c("Positive","Not Significant","Negative"))
levels(plot.data$Sig_Trend)

#choose line and fill colors
mycolors<-c("royalblue",I("gray30"),"red")
myfills<-c(alpha("royalblue",0.6),alpha(I("gray30"),0.6),alpha("red",0.6))


#now plot trends by EventDate
  SETallDatesSite_noOutliers<-ggplot(data=plot.data, aes(x=Date, y=value, 
                                                         group=1))+
    geom_point(color="gray50",alpha=0.7, size=1, shape=16)+
    #geom_path(aes(color=Plot_Name),alpha=0.2)+
        geom_smooth(aes(x=Date, y=value, group=pos.pin),method="lm",
                    color="gray80",size=0.4,alpha=0.1,inherit.aes = FALSE, 
                    se=FALSE)+
geom_smooth(aes(color=Site_Sig_Trend, fill=Site_Sig_Trend),method=lm, 
            fullrange=TRUE, linetype=1, se=TRUE,alpha=0.3)+
    scale_color_manual(values=mycolors, drop=FALSE)+
    scale_fill_manual(values=myfills,drop=FALSE)+
    scale_y_continuous(expand=c(0.1,0.1))+
    scale_x_date(date_breaks = "2 year",date_labels = "%Y")+
        theme(panel.background = element_rect(color="black",fill="transparent"),
          panel.border = element_rect(color="black", fill="transparent"),
          axis.text.x = element_text(size=7, color="black"),
          axis.text.y = element_text(size=7, color="black"),
          axis.title.x = element_text(size=9, hjust=0.5, vjust=1.9),
          axis.title.y = element_text(angle = 90, vjust=1.2, size=10),
          title=element_text(size=13),
          legend.position = "none",
          legend.key.size = unit(1,"line"),
          legend.text = element_text(size=8),
          legend.title=element_text(size=14),
          legend.background = element_rect(fill=alpha("white",0.9), 
                                           color="transparent"))+
    geom_hline(yintercept=0, linetype=2, color="gray30",alpha=0.8)+
    stat_poly_eq(formula = y~ x,eq.with.lhs = "italic(hat(y))~`=`~",
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                 parse = TRUE)+
    labs(x="Year", y="Relative difference in pin height (mm)", 
         title = wrapper(paste("C) Pin-level slopes (light gray lines) and 
                               linear model trend (mean ± SE; shown in color, 
                               if significant) of relative change in wetland 
                               elevation mm/day at ", 
                               siteName, " site within ",refugeName, " NWR.",sep=""), 
                         width=80))
  

  #now set up plot for stations
    SETallDatesPlot_noOutliers<-ggplot(data=plot.data, aes(x=Date, y=value, 
                                                           group=1))+
    geom_point(color="gray50",alpha=0.7, size=1, shape=16)+
        geom_smooth(aes(x=Date, y=value, group=pos.pin),method="lm",
                    color="gray80",size=0.4,alpha=0.1,inherit.aes = FALSE, se=FALSE)+
geom_smooth(aes(color=Sig_Trend, fill=Sig_Trend),method=lm, fullrange=TRUE, 
            linetype=1, se=TRUE,alpha=0.3)+
    scale_color_manual(values=mycolors,drop=FALSE)+
    scale_fill_manual(values=myfills,drop=FALSE)+
    scale_y_continuous(expand=c(0.1,0.1))+
    scale_x_date(date_breaks = "2 year",date_labels = "%Y")+
        theme(panel.background = element_rect(color="black",fill="transparent"),
          panel.border = element_rect(color="black", fill="transparent"),
          axis.text.x = element_text(size=7, color="black"),
          axis.text.y = element_text(size=7, color="black"),
          axis.title.x = element_text(size=9, hjust=0.5, vjust=1.9),
          axis.title.y = element_text(angle = 90, vjust=1.2, size=10),
          title=element_text(size=13),
          legend.position = "none",
          legend.key.size = unit(1,"line"),
          legend.text = element_text(size=8),
          legend.title=element_text(size=14),
          legend.background = element_rect(fill=alpha("white",0.9), 
                                           color="transparent"))+
    geom_hline(yintercept=0, linetype=2, color="gray30",alpha=0.8)+
    stat_poly_eq(formula = y~ x,eq.with.lhs = "italic(hat(y))~`=`~",
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                 parse = TRUE)+
    labs(x="Year", y="Relative difference in pin height (mm)", 
         title = wrapper(paste("C) Pin-level slopes (light gray lines) and 
                               linear model trend (mean ± SE; shown in color, 
                               if significant) of relative change in wetland 
                               elevation (mm/day) at ", siteName, " site within ",
                               refugeName, " NWR.",sep=""), width=80))


#create facet plot of individual stations
SETallDatesPlot_noOutliers_facet<-SETallDatesPlot_noOutliers+
  facet_wrap(~Plot_Name, drop=TRUE,ncol=1)+
  ggtitle(wrapper("B) Pin-level linear regression of change in elevation 
                  by sampling date (mm/day) among SET stations.", width=50))+
    theme(strip.text=element_text(size=8),
          legend.position = "bottom", 
          axis.title.y=element_text(size=12),
          title=element_text(size=10))

cat("\\vskip 1mm")

#Print Site name big
cat("\\begin{huge}")
  cat(siteName)
cat("\\end{huge}")

cat("\\vskip 1mm")

#Intro paragraph
cat("Surface elevation table (SET) data were collected between ",
    site.sampling.info$`Start Year`,"-",site.sampling.info$`End Year`," at A) ", 
    site.sampling.info$`SETs (N)`, " SET stations at ",siteName, " within the ", 
    refugeName, " NWR. The estimated trend in change in surface elevation 
    (mean \u00B1 SE) was ", 
    round(site.mean.df$mean,2), " \u00B1 ",round(site.mean.df$SE,2),
    ". Slope equations for pin-level linear regression models of mean trends 
    (mm/day) are shown below for B) individual stations and C) at the site level.",sep="")

cat("\\vskip 1mm")

library(ggpubr)
#combine trendMapSite and 
plot1<-ggarrange(trendMapSite, SETallDatesPlot_noOutliers_facet, 
                 heights=c(1,0.7), widths=c(1,0.75))

#print map
subchunkify(plot1, 6, 9)
#print(trendMapSite)
  
#plot Site
#print(SETallDatesPlot_noOutliers_Site)
subchunkify(SETallDatesSite_noOutliers, 3.7,9)

#add blank lines
#cat("\\newline")


#add blank lines
cat("\n\\clearpage\n")

}

```

```{r, message=FALSE, warning=FALSE, eval=FALSE, echo=TRUE, tidy = FALSE}

### Appendix A. Pin-level regression plots at each SET station 
#(among 4 arm positions)

siteList<-site.order.table$Site

for(i in 1:length(siteList)){
  site.data<-subset(data, Site_Name==siteList[i])

    #get stationList
    stationList<-unique(as.character(site.data$Plot_Name))
    
    # for(k in 1:length(stationList)){
    #   
    #   plot.data<-subset(site.data, Plot_Name==stationList[k])
      
      site.data$PositionLabels<-paste("Position ", 
                                      site.data$PipeDirectionCode,sep="")
    
      pin.reg.plot<-ggplot(site.data, aes(x=Date, y=value))+
        geom_point(aes(color=variable),size=0.7,alpha=0.5)+
        geom_smooth(method="lm",aes(color=variable),se=FALSE,alpha=0.4, size=0.5)+
        scale_x_date(date_breaks="1 year",date_labels = "%b\n%Y", minor_breaks = "1 year")+
        ylab("Delta Elevation (mm)")+
        geom_hline(yintercept=0,linetype=2, color="darkgray")+
        theme(panel.background =element_rect(fill="white"),
              panel.grid.major=element_line(color=alpha("lightgray",0.4)),
              panel.border=element_rect(fill="transparent",color="black"),
              axis.text.x=element_text(size=5))
      #pin.reg.plot

      #plot of all pin-level linear models
      pin.reg.plot+facet_wrap(Plot_Name~PositionLabels,ncol=4)+
        labs(color = "Pin")+
        ggtitle(paste(refugeList[i],"NWR:", siteList[j],"-","SET",
                      stationList[k], sep=" "))

      pin.reg.facet<-pin.reg.plot+facet_wrap(Plot_Name~PositionLabels,ncol=4)+
        labs(color = "Pin")+
        ggtitle(paste(refugeList[i],"NWR:", siteList[j],"-","SET",
                      stationList[k], sep=" "))

      print(pin.reg.facet)
    
      }
    }
  }

```
